<!-- src/main/resources/templates/problems/list.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko" th:inline="javascript">
<head>
    <meta charset="UTF-8">
    <title>ë¬¸ì œ ëª©ë¡ | ê³µì¸ì¤‘ê°œì‚¬ ê¸°ì¶œëª¨ì•„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSRF (ìˆìœ¼ë©´ ìë™ ì‚¬ìš©) -->
    <meta name="_csrf" th:content="${_csrf?.token}">
    <meta name="_csrf_header" th:content="${_csrf?.headerName}">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

    <style>
        :root{
            --color-main:#2F4858; --color-sub:#4F7CAC; --color-point:#F5CD90;
            --text-main:#2C3E3F; --text-sub:#7A746E; --bg:#F4F3F1; --white:#ffffff;
            --radius:18px; --shadow:0 10px 24px rgba(47,72,88,.15);
        }
        body{
            background:var(--bg); color:var(--text-main);
            font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
            letter-spacing:.1px;
        }
        .page-wrap{ max-width: 1300px; margin: clamp(24px,5vh,72px) auto; padding: 0 14px; }

        .top-actions{
            position: sticky; top: 8px; z-index: 20;
            display:flex; justify-content:flex-end; gap:8px; margin-bottom:8px;
        }
        .top-actions .btn{ box-shadow: 0 6px 16px rgba(47,72,88,.12); }

        .brand{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
        .brand img{ height:36px; }
        .brand .title{ font-weight:900; font-size:18px; }
        .muted{ color:var(--text-sub); }

        .card-box{
            border:0; background:var(--white); border-radius:var(--radius);
            box-shadow:var(--shadow); padding:22px;
        }
        .card-head{
            display:flex; flex-wrap:wrap; gap:12px;
            align-items:center; justify-content:space-between; margin-bottom:12px;
        }
        .card-title{ margin:0; color:var(--color-main); font-weight:800; font-size:18px; }

        .btn-uniform{ padding:10px 14px; min-height:44px; border-radius:12px; font-weight:700; font-size:1rem; }
        .btn-sub{ background:var(--color-sub); border-color:var(--color-sub); color:#fff; }
        .btn-sub:hover{ background:#426d96; border-color:#426d96; }
        .btn-dashboard{ background:#6c757d; border-color:#6c757d; color:#fff; }
        .btn-dashboard:hover{ background:#5a6268; border-color:#5a6268; }

        .table-scroll{ max-height: 68vh; overflow:auto; border-radius:12px; }
        .table-sticky thead th{ position: sticky; top: 0; z-index: 1; background: #f8f9fa; }
        .table thead th{ font-weight:800; }
        .truncate{ max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .actions{
            display:flex; gap:6px; justify-content:center; align-items:center;
            flex-wrap:wrap; white-space:nowrap;
        }
        .btn-icon{
            width:34px; height:34px; padding:0;
            display:inline-flex; align-items:center; justify-content:center;
            border-radius:8px; border:1px solid transparent;
        }
        .btn-icon.view{ border-color:#c9c4bd; background:#fff; color:#2F4858; }
        .btn-icon.view:hover{ background:#f0efec; }
        .btn-icon.edit{ border-color:#c9c4bd; background:#fff; color:#4F7CAC; }
        .btn-icon.edit:hover{ background:#eef3f9; }
        .btn-icon.del{ border-color:#f3c9c9; background:#fff5f5; color:#a33a3a; }
        .btn-icon.del:hover{ background:#ffecec; }
        .btn-icon.code{ border-color:#c9c4bd; background:#fff; color:#2F4858; }
        .btn-icon.code:hover{ background:#f0efec; }

        .fab{
            position: fixed; right: 16px; bottom: 20px; z-index: 50;
            width:56px; height:56px; border-radius:50%;
            display:none; align-items:center; justify-content:center;
            background: var(--color-sub); color:#fff;
            box-shadow:0 10px 24px rgba(47,72,88,.25);
            text-decoration:none;
        }
        .fab:hover{ background:#426d96; color:#fff; }

        @media (max-width: 768px){
            .top-actions{ display:none; }
            .fab{ display:flex; }
            .truncate{ max-width: 180px; }
        }

        /* ===== í•„í„° ì˜ì—­ ===== */
        .filter-form{
            display:flex; flex-wrap:wrap;
            gap:10px; margin-bottom:8px; align-items:flex-start;
        }
        .filter-group{
            min-width: 220px;
        }
        .filter-label{
            font-size:.85rem; color:var(--text-sub); margin-bottom:4px;
            font-weight:600;
        }

        .chip-row{
            display:flex;
            flex-direction:column;
            gap:6px;
            max-width:420px;
        }
        .chip-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:8px;
        }
        .chip-header .text-muted{
            white-space:nowrap;
        }
        .chip-scroll{
            display:flex;
            flex-wrap:wrap;
            gap:6px;
            max-height:200px;
            overflow:auto;
            padding:4px 2px;
            border-radius:10px;
            background:#f8f9fa;
        }
        .filter-chip{
            border-radius:999px;
            padding:4px 10px;
            font-size:.8rem;
            border-color:#d0d4da;
            color:var(--text-main);
            background:#fff;
            transition: all .15s ease-out;
        }
        .filter-chip:hover{
            background:#eef3f9;
            border-color:var(--color-sub);
            color:var(--color-sub);
        }

        /* âœ… ì¹© ì„ íƒ ìƒíƒœ (ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤ ê³µí†µ) */
        .btn-check:checked + .filter-chip{
            background: var(--color-sub);
            border-color: var(--color-sub);
            color:#fff;
            box-shadow: 0 0 0 1px rgba(79,124,172,.25);
        }
        .btn-check:focus + .filter-chip{
            box-shadow: 0 0 0 2px rgba(79,124,172,.35);
        }

        .filter-all-btn{
            border-radius:999px;
            padding:3px 10px;
            font-size:.8rem;
            border:1px dashed #d0d4da;
            background:#fff;
            color:var(--text-sub);
            display:inline-flex;
            align-items:center;
            gap:4px;
        }
        .filter-all-btn:hover{
            background:#fffef7;
            border-color:var(--color-point);
            color:#b07a1a;
        }
        /* ì „ì²´ íšŒì°¨/ë‹¨ì› ON ìƒíƒœ */
        .filter-all-btn.is-active{
            background: var(--color-point);
            border-color: var(--color-point);
            color: var(--color-main);
            font-weight: 600;
            box-shadow: 0 0 0 1px rgba(245,205,144,.5);
        }
        .filter-all-btn.is-active:hover{
            background:#f2bd63;
            border-color:#f2bd63;
            color:var(--color-main);
        }

        /* âœ… ë‹¨ì› ì¹© ìˆœë²ˆ ìë™ ë¶€ì—¬ (01, 02, 03...) */
        .units-scroll{
            counter-reset: unit-counter;
        }
        .units-scroll .filter-chip{
            position: relative;
            padding-left: 32px;
        }
        .units-scroll .filter-chip::before{
            counter-increment: unit-counter;
            content: counter(unit-counter, decimal-leading-zero) ".";
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-weight: 700;
            font-size: .8rem;
            color: var(--color-sub);
        }

        /* âœ… í•„í„° ìš”ì•½ ë°” */
        .filter-summary{
            margin-bottom: 14px;
            padding: 6px 12px;
            border-radius: 999px;
            background: #f8f9fa;
            color: var(--text-sub);
            display:flex;
            flex-wrap:wrap;
            gap:4px 10px;
            font-size:.85rem;
        }
        .filter-summary strong{
            color: var(--color-main);
        }
        .filter-summary .dot{
            opacity:.4;
        }

        .status-box{ padding:12px 0; text-align:center; color:var(--text-sub); }
        .status-box .loading{ color:var(--color-sub); }
        .status-box .done{ color:#6c757d; }
        .status-box .empty{ color:#6c757d; }
        .d-none{ display:none !important; }

        /* ì¸ë¼ì¸ ì½”ë“œ ì—ë””í„° */
        .code-editor{ background:#fffdfa; }
        .editor-wrap{
            padding:14px; border:1px dashed #e8c27a; border-radius:12px;
            background:#fff7e8;
        }
        .editor-wrap .form-control{
            border-radius:10px; border:1px solid #d9d6d1; padding:8px 10px;
        }
        .editor-wrap .badge{ background:#f1efe9; color:#6a5a2d; }
        .preview-pill{
            background:#fff; border:1px dashed #e8c27a; color:#6a5a2d;
            border-radius:10px; padding:6px 8px; font-weight:700;
            font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
        }
        .editor-actions{ display:flex; gap:8px; justify-content:flex-end; }
        .btn-main{ background:var(--color-main); border-color:var(--color-main); color:#fff; }
        .btn-main:hover{ background:#243946; border-color:#243946; }
        .btn-ghost{ border:1px solid #c9c4bd; background:transparent; color: var(--text-main); }
        .btn-ghost:hover{ background:#f0efec; }

        .code-cell{
            font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
            font-weight:700; letter-spacing:.5px;
        }
    </style>
</head>
<body>

<main class="page-wrap">
    <div class="top-actions">
        <a class="btn btn-sub btn-uniform"
           th:if="${loginUser != null and loginUser.role == T(com.pro.project01.v2.domain.user.entity.Role).ADMIN}"
           th:href="@{/problems/new}">
            <i class="bi bi-plus-lg me-1"></i>ë¬¸ì œë“±ë¡
        </a>
        <a class="btn btn-dashboard btn-uniform" th:href="@{/dashboard}">
            <i class="bi bi-speedometer2 me-1"></i>ëŒ€ì‹œë³´ë“œ
        </a>
    </div>

    <div class="brand">
        <img src="/img/brandLogo.png" alt="ë¡œê³ ">
        <div class="title">ê³µì¸ì¤‘ê°œì‚¬ ê¸°ì¶œëª¨ì•„</div>
        <div class="muted">ë¬¸ì œ ëª©ë¡</div>
    </div>

    <!-- â–¼ í•„í„° í¼: ê³¼ëª©(ì¹©/ë‹¨ì¼) / íšŒì°¨(ì¹©/ë³µìˆ˜) / ë‹¨ì›(ì¹©/ë³µìˆ˜) -->
    <form class="filter-form" th:action="@{/problems}" method="get">
        <!-- ê³¼ëª© (ì¹©, ë‹¨ì¼ ì„ íƒ) -->
        <div class="filter-group">
            <div class="filter-label">ê³¼ëª©</div>
            <div class="chip-row">
                <div class="chip-scroll">
                    <!-- ì „ì²´ ê³¼ëª© -->
                    <input type="radio"
                           class="btn-check"
                           id="subject-0"
                           name="subjectId"
                           value="0"
                           th:checked="${subjectId == null or subjectId == 0}"
                           onclick="this.form.submit()">
                    <label class="btn btn-outline-secondary btn-sm filter-chip"
                           for="subject-0">ì „ì²´</label>

                    <!-- ê°œë³„ ê³¼ëª© -->
                    <th:block th:each="s : ${subjects}">
                        <input type="radio"
                               class="btn-check"
                               th:id="|subject-${s.id}|"
                               name="subjectId"
                               th:value="${s.id}"
                               th:checked="${subjectId != null and subjectId == s.id}"
                               onclick="this.form.submit()">
                        <label class="btn btn-outline-secondary btn-sm filter-chip"
                               th:for="|subject-${s.id}|"
                               th:text="${s.name}"></label>
                    </th:block>
                </div>
            </div>
        </div>

        <!-- íšŒì°¨ (ë³µìˆ˜ ì„ íƒ ì¹©) -->
        <div class="filter-group">
            <div class="filter-label">íšŒì°¨</div>
            <div class="chip-row">
                <div class="chip-header">
                    <span class="text-muted small">ì—¬ëŸ¬ íšŒì°¨ë¥¼ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                    <button type="button"
                            class="filter-all-btn btn btn-sm"
                            th:classappend="${selectedRoundIds == null or #lists.isEmpty(selectedRoundIds)} ? ' is-active' : ''"
                            onclick="selectAllRounds()">
                        <i class="bi bi-layers"></i> ì „ì²´ íšŒì°¨
                    </button>
                </div>
                <div class="chip-scroll">
                    <th:block th:each="r : ${rounds}">
                        <input type="checkbox"
                               class="btn-check"
                               th:id="|round-${r.id}|"
                               name="roundIds"
                               th:value="${r.id}"
                               th:checked="${selectedRoundIds != null and selectedRoundIds.contains(r.id)}">
                        <label class="btn btn-outline-secondary btn-sm filter-chip"
                               th:for="|round-${r.id}|"
                               th:text="${r.name}"></label>
                    </th:block>
                </div>
            </div>
        </div>

        <!-- ë‹¨ì› (ë³µìˆ˜ ì„ íƒ ì¹©) -->
        <div class="filter-group">
            <div class="filter-label">ë‹¨ì›</div>
            <div class="chip-row">
                <div class="chip-header">
                    <span class="text-muted small">ì—¬ëŸ¬ ë‹¨ì›ì„ ë™ì‹œì— ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                    <button type="button"
                            class="filter-all-btn btn btn-sm"
                            th:classappend="${selectedUnitIds == null or #lists.isEmpty(selectedUnitIds)} ? ' is-active' : ''"
                            onclick="selectAllUnits()">
                        <i class="bi bi-list-ol"></i> ì „ì²´ ë‹¨ì›
                    </button>
                </div>
                <!-- âœ… ìˆœë²ˆ ìë™ ë¶€ì—¬ìš© units-scroll -->
                <div class="chip-scroll units-scroll">
                    <th:block th:each="u : ${units}">
                        <input type="checkbox"
                               class="btn-check"
                               th:id="|unit-${u.id}|"
                               name="unitIds"
                               th:value="${u.id}"
                               th:checked="${selectedUnitIds != null and selectedUnitIds.contains(u.id)}">
                        <label class="btn btn-outline-secondary btn-sm filter-chip"
                               th:for="|unit-${u.id}|"
                               th:text="${u.name}"></label>
                    </th:block>
                </div>
            </div>
        </div>

        <!-- í•„í„° ì ìš© ë²„íŠ¼ -->
        <div class="d-flex align-items-end">
            <button type="submit" class="btn btn-sub btn-sm">
                <i class="bi bi-funnel me-1"></i>í•„í„° ì ìš©
            </button>
        </div>

        <noscript><button type="submit" class="btn btn-sub btn-sm">ì¡°íšŒ</button></noscript>
    </form>

    <!-- âœ… í˜„ì¬ í•„í„° ìš”ì•½ -->
    <div class="filter-summary small text-muted" id="filterSummary">
        ì „ì²´ ë¬¸ì œë¥¼ ë³´ê³  ìˆìŠµë‹ˆë‹¤.
    </div>

    <section class="card-box">
        <div class="card-head">
            <h2 class="card-title">
                ì „ì²´ ë¬¸ì œ
                <span id="countBadge" class="badge text-bg-light ms-2">0ê±´</span>
            </h2>
            <div class="d-flex gap-2">
                <a class="btn btn-sub btn-sm"
                   th:if="${loginUser != null and loginUser.role == T(com.pro.project01.v2.domain.user.entity.Role).ADMIN}"
                   th:href="@{/problems/new}">
                    <i class="bi bi-plus-lg me-1"></i>ë¬¸ì œë“±ë¡
                </a>
                <a class="btn btn-dashboard btn-sm" th:href="@{/dashboard}">
                    <i class="bi bi-speedometer2 me-1"></i>ëŒ€ì‹œë³´ë“œ
                </a>
            </div>
        </div>

        <div class="table-scroll" id="scrollRoot">
            <table class="table table-bordered table-sm align-middle text-center mb-0 table-sticky">
                <thead class="table-light">
                <tr>
                    <th style="width:50px;">ë²ˆí˜¸</th>
                    <th style="width:100px;">íšŒì°¨ì½”ë“œ</th>
                    <th style="width:100px;">ë‹¨ì›ì½”ë“œ</th>
                    <th>ì œëª©</th>
                    <th>ì§€ë¬¸</th>
                    <th>ê³¼ëª©</th>
                    <th>íšŒì°¨</th>
                    <th>ë‹¨ì›</th>
                    <th style="width:280px;">ì‘ì—…</th>
                </tr>
                </thead>
                <tbody id="listBody"></tbody>
            </table>
            <div id="sentinel" style="height:24px;"></div>
        </div>

        <div class="status-box">
            <span class="loading d-none">ë¡œë”© ì¤‘â€¦</span>
            <span class="empty d-none">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>
            <span class="done d-none">ë§ˆì§€ë§‰ì…ë‹ˆë‹¤.</span>
        </div>
    </section>
</main>

<a class="fab"
   th:if="${loginUser != null && loginUser.role == T(com.pro.project01.v2.domain.user.entity.Role).ADMIN}"
   th:href="@{/problems/new}" title="ë¬¸ì œë“±ë¡">
    <i class="bi bi-plus-lg"></i>
</a>

<script>
    /* ===== ì„œë²„ íŒŒë¼ë¯¸í„° ===== */
    const subjectId = /*[[${subjectId}]]*/ null;
    const roundIds  = /*[[${selectedRoundIds}]]*/ [];
    const unitIds   = /*[[${selectedUnitIds}]]*/ [];
    const size      = /*[[${size}]]*/ 40;
    const q         = /*[[${q}]]*/ null;

    /* ===== CSRF ===== */
    const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content || null;
    const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content || null;
    const CSRF_PARAM = '_csrf';

    function withCsrf(init={}) {
        init.headers = init.headers || {};
        if (CSRF_TOKEN && CSRF_HEADER) init.headers[CSRF_HEADER]=CSRF_TOKEN;
        return init;
    }

    /* ===== ìƒíƒœ ===== */
    let loading=false, hasNext=true, firstLoad=true;
    let nextId=null; // ì»¤ì„œ ID
    const listBody = document.getElementById('listBody');
    const $count   = document.getElementById('countBadge');
    const statusBox= document.querySelector('.status-box');
    const $loading = statusBox.querySelector('.loading');
    const $empty   = statusBox.querySelector('.empty');
    const $done    = statusBox.querySelector('.done');

    function show(which){
        $loading.classList.add('d-none');
        $empty.classList.add('d-none');
        $done.classList.add('d-none');
        if(which) which.classList.remove('d-none');
    }

    /* ===== ëˆ„ì /ì¤‘ë³µ ë°©ì§€ ===== */
    const allItems = [];
    const seenIds  = new Set();

    /* ===== íšŒì°¨ ìˆ«ì(RR) ì¶”ì¶œ (ì½”ë“œ ì—ë””í„°/ì½”ë“œ í‘œì‹œìš©) ===== */
    function rrNum(s){
        const m = String(s||'').match(/(\d{1,3})/);
        return m ? parseInt(m[1],10) : Number.MAX_SAFE_INTEGER;
    }

    /* ===== ì „ì—­ ì •ë ¬ (ê³¼ëª© ë‚´ ê³ ìœ ë²ˆí˜¸ ê¸°ì¤€) ===== */
    function sortItems(items){
        items.sort((a, b) => {
            const na = (a.subjectProblemNo != null)
                ? a.subjectProblemNo
                : (a.roundProblemNo != null ? a.roundProblemNo : Number.POSITIVE_INFINITY);

            const nb = (b.subjectProblemNo != null)
                ? b.subjectProblemNo
                : (b.roundProblemNo != null ? b.roundProblemNo : Number.POSITIVE_INFINITY);

            if (na !== nb) return na - nb;

            // ë²ˆí˜¸ê°€ ê°™ìœ¼ë©´ idë¡œ ì•ˆì • ì •ë ¬
            return (a.id ?? 0) - (b.id ?? 0);
        });
    }

    /* ===== ì „ì²´ ì¬ë Œë” ===== */
    function renderAll(){
        const scrollRoot = document.getElementById('scrollRoot');
        const oldTop = scrollRoot.scrollTop;
        listBody.innerHTML = allItems.map(rowTemplate).join('');
        allItems.forEach(it => bindEditorBehavior(it.id));
        scrollRoot.scrollTop = oldTop;
        fillDetailsFor(allItems);
    }

    /* ===== ìœ í‹¸ ===== */
    function escapeHtml(str){ if(str==null) return ''; return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
    function pad2(n){ n=parseInt(n,10); if(isNaN(n)) return ''; return n<10?'0'+n:String(n); }
    function pad3(s){ s=String(s??'').replace(/\D/g,''); if(!s) return ''; return s.padStart(3,'0').slice(-3); }
    function onlyDigits(s,len){ s=String(s??'').replace(/\D/g,''); if(!s) return ''; return len?s.slice(0,len):s; }

    /* ===== ì¸ë¼ì¸ ì½”ë“œ ì—ë””í„° ===== */
    function editorTemplate(item){
        const rr = (String(item.roundName||'').match(/(\d{1,3})/)?.[1]) || '';
        return `
<tr class="code-editor d-none" id="code-editor-${item.id}">
  <td colspan="9">
    <div class="editor-wrap">
      <div class="row g-2">
        <div class="col-4 col-md-3">
          <label class="form-label mb-1" for="sc-${item.id}">ê³¼ëª© ì½”ë“œ (SS)</label>
          <input type="text" class="form-control" id="sc-${item.id}" maxlength="2" inputmode="numeric" placeholder="ì˜ˆ: 01">
        </div>
        <div class="col-4 col-md-3">
          <label class="form-label d-flex align-items-center justify-content-between mb-1">
            íšŒì°¨ ë²ˆí˜¸ (RR) <span class="badge">ì½ê¸°ì „ìš©</span>
          </label>
          <input type="text" class="form-control" value="${rr}" disabled>
        </div>
        <div class="col-4 col-md-3">
          <label class="form-label mb-1" for="rp-${item.id}">íšŒì°¨ ë‚´ ë²ˆí˜¸ (PP, 1~40)</label>
          <input type="number" class="form-control" id="rp-${item.id}" min="1" max="40" placeholder="ì˜ˆ: 1">
        </div>
        <div class="col-12 col-md-3">
          <label class="form-label d-flex align-items-center justify-content-between mb-1">
            íšŒì°¨ ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° <span class="badge">SS_RR_PP</span>
          </label>
          <div class="preview-pill" id="round-prev-${item.id}">--</div>
        </div>

        <div class="col-4 col-md-3">
          <label class="form-label mb-1" for="uc-${item.id}">ë‹¨ì› ì½”ë“œ (UUU)</label>
          <input type="text" class="form-control" id="uc-${item.id}" maxlength="3" inputmode="numeric" placeholder="ì˜ˆ: 001">
        </div>
        <div class="col-4 col-md-3">
          <label class="form-label mb-1" for="up-${item.id}">ë‹¨ì› ë‚´ ìˆœë²ˆ (PP, 1~99)</label>
          <input type="number" class="form-control" id="up-${item.id}" min="1" max="99" placeholder="ì˜ˆ: 1">
        </div>
        <div class="col-12 col-md-6">
          <label class="form-label d-flex align-items-center justify-content-between mb-1">
            ë‹¨ì› ì½”ë“œ ë¯¸ë¦¬ë³´ê¸° <span class="badge">SS_UUU_PP</span>
          </label>
          <div class="preview-pill" id="unit-prev-${item.id}">--</div>
        </div>
      </div>

      <div class="editor-actions mt-3">
        <button type="button" class="btn btn-ghost btn-sm" onclick="toggleEditor(${item.id}, false)">ì·¨ì†Œ</button>
        <button type="button" class="btn btn-main btn-sm" onclick="saveCodes(${item.id})">ì €ì¥</button>
      </div>
    </div>
  </td>
</tr>`;
    }

    function bindEditorBehavior(id){
        const rr = document.querySelector(`#code-editor-${id} input[disabled]`)?.value || '';
        const rp = document.getElementById(`rp-${id}`);
        const sc = document.getElementById(`sc-${id}`);
        const uc = document.getElementById(`uc-${id}`);
        const up = document.getElementById(`up-${id}`);
        const roundPrev = document.getElementById(`round-prev-${id}`);
        const unitPrev  = document.getElementById(`unit-prev-${id}`);

        function renderRoundCode(){
            const SS=(onlyDigits(sc.value,2)||'').padStart(2,'0').slice(-2);
            const PP=pad2(rp.value);
            roundPrev.textContent=(SS&&rr&&PP)?`${SS}_${rr}_${PP}`:'--';
        }
        function renderUnitCode(){
            const SS=(onlyDigits(sc.value,2)||'').padStart(2,'0').slice(-2);
            const UUU=pad3(uc.value);
            const PP=pad2(up.value);
            unitPrev.textContent=(SS&&UUU&&PP)?`${SS}_${UUU}_${PP}`:'--';
        }

        rp?.addEventListener('input', renderRoundCode);
        sc?.addEventListener('input', e=>{
            e.target.value=onlyDigits(e.target.value,2);
            renderRoundCode(); renderUnitCode();
        });
        uc?.addEventListener('input', e=>{
            e.target.value=onlyDigits(e.target.value,3);
            renderUnitCode();
        });
        up?.addEventListener('input', renderUnitCode);
        renderRoundCode(); renderUnitCode();
    }

    /* ===== í–‰ í…œí”Œë¦¿ ===== */
    function rowTemplate(it){
        const id = it.id;
        const title = escapeHtml(it.title ?? '');
        const subjectName = escapeHtml(it.subjectName ?? '');
        const roundName = escapeHtml(it.roundName ?? '');
        const unitName = escapeHtml(it.unitName ?? '');
        const viewPreview = 'â€”';

        // âœ… ë²ˆí˜¸: subjectProblemNo â†’ ì—†ìœ¼ë©´ roundProblemNo â†’ ì—†ìœ¼ë©´ 'â€”'
        const numberCell =
            (it.subjectProblemNo != null) ? it.subjectProblemNo :
                (it.roundProblemNo != null ? it.roundProblemNo : 'â€”');

        return `
<tr id="row-${id}">
  <td id="num-${id}">${numberCell}</td>
  <td class="code-cell" id="roundcode-${id}">â€”</td>
  <td class="code-cell" id="unitcode-${id}">â€”</td>
  <td class="truncate" title="${title}">
    <a class="link-dark fw-semibold" href="/problems/${id}">${title || '(ì œëª© ì—†ìŒ)'}</a>
  </td>
  <td class="truncate" title="${viewPreview}">${viewPreview}</td>
  <td>${subjectName}</td>
  <td>${roundName}</td>
  <td>${unitName}</td>
  <td>
    <div class="actions">
      <a class="btn btn-icon view" href="/problems/${id}" title="ìƒì„¸">
        <i class="bi bi-box-arrow-up-right"></i>
      </a>
      <a class="btn btn-icon edit" href="/problems/${id}/edit" title="ìˆ˜ì •">
        <i class="bi bi-pencil"></i>
      </a>

      <button type="button"
              class="btn btn-icon code"
              title="ì½”ë“œìˆ˜ì •"
              onclick="toggleEditor(${id}, true)">
        <i class="bi bi-braces-asterisk"></i>
      </button>

      <!-- ğŸ”¼ ìœ„ë¡œ -->
      <form action="/problems/${id}/moveUp" method="post" class="m-0 p-0 d-inline">
        ${CSRF_TOKEN ? `<input type="hidden" name="${CSRF_PARAM}" value="${CSRF_TOKEN}">` : ''}
        <button type="submit" class="btn btn-icon" title="ìœ„ë¡œ"
                style="border-color:#c9c4bd;background:#fff;color:#2F4858;">
          <i class="bi bi-arrow-up"></i>
        </button>
      </form>

      <!-- ğŸ”½ ì•„ë˜ë¡œ -->
      <form action="/problems/${id}/moveDown" method="post" class="m-0 p-0 d-inline">
        ${CSRF_TOKEN ? `<input type="hidden" name="${CSRF_PARAM}" value="${CSRF_TOKEN}">` : ''}
        <button type="submit" class="btn btn-icon" title="ì•„ë˜ë¡œ"
                style="border-color:#c9c4bd;background:#fff;color:#2F4858;">
          <i class="bi bi-arrow-down"></i>
        </button>
      </form>

      <!-- ğŸ—‘ ì‚­ì œ -->
      <form action="/problems/${id}/delete"
            method="post"
            class="m-0 p-0 d-inline"
            onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        ${CSRF_TOKEN ? `<input type="hidden" name="${CSRF_PARAM}" value="${CSRF_TOKEN}">` : ''}
        <button type="submit" class="btn btn-icon del" title="ì‚­ì œ">
          <i class="bi bi-trash"></i>
        </button>
      </form>
    </div>
  </td>
</tr>
${editorTemplate(it)}`;
    }

    /* ===== ê°œìˆ˜ ì¡°íšŒ ===== */
    async function fetchCount(){
        try{
            const params = new URLSearchParams();
            if(subjectId && subjectId !== 0){
                params.set('subjectId', subjectId);
            }
            if(Array.isArray(roundIds) && roundIds.length > 0){
                roundIds.forEach(id => {
                    if(id) params.append('roundIds', id);
                });
            }
            if(Array.isArray(unitIds) && unitIds.length > 0){
                unitIds.forEach(id => {
                    if(id) params.append('unitIds', id);
                });
            }
            const url = params.toString()
                ? `/problems/api/problems/count?${params.toString()}`
                : `/problems/api/problems/count`;

            const res = await fetch(url);
            if(!res.ok) return;
            const data = await res.json();
            if(data && typeof data.count === 'number'){
                $count.textContent = data.count + 'ê±´';
            }
        }catch(e){}
    }

    /* ===== ìƒì„¸ ìºì‹œ & ì…€ ì±„ìš°ê¸° ===== */
    const detailsCache = new Map();
    async function fetchDetails(id){
        if(detailsCache.has(id)) return detailsCache.get(id);
        try{
            const res = await fetch(`/problems/${id}/api`, {method:'GET'});
            if(!res.ok) return null;
            const data = await res.json();
            detailsCache.set(id,data);
            return data;
        }catch(e){ return null; }
    }

    function renderCellsFromDetails(item, data){
        const id=item.id;
        const elNum = document.getElementById(`num-${id}`);
        // ë²ˆí˜¸ëŠ” ì²˜ìŒ ë Œë” ì‹œ subjectProblemNo/roundProblemNoë¡œ ì±„ì›Œì§€ë¯€ë¡œ,
        // ì—¬ê¸°ì„œëŠ” ë¹„ì–´ìˆëŠ” ê²½ìš°ì—ë§Œ roundProblemNoë¡œ ë³´ì™„
        if(elNum && data && data.roundProblemNo != null && (elNum.textContent === 'â€”' || elNum.textContent === '' )){
            elNum.textContent = data.roundProblemNo;
        }

        const rr = (String(item.roundName||'').match(/(\d{1,3})/)?.[1]) || '';
        const SS = (data?.subjectCode!=null) ? String(data.subjectCode).padStart(2,'0').slice(-2) : '';
        const UUU= (data?.unitSeqCode!=null) ? String(data.unitSeqCode).padStart(3,'0').slice(-3) : '';
        const PP1= (data?.roundProblemNo!=null) ? pad2(data.roundProblemNo) : '';
        const PP2= (data?.unitProblemNo!=null) ? pad2(data.unitProblemNo) : '';

        const roundCode = (SS && rr && PP1) ? `${SS}_${rr}_${PP1}` : 'â€”';
        const unitCode  = (SS && UUU && PP2) ? `${SS}_${UUU}_${PP2}` : 'â€”';

        const elRound = document.getElementById(`roundcode-${id}`);
        const elUnit  = document.getElementById(`unitcode-${id}`);
        if(elRound) elRound.textContent = roundCode;
        if(elUnit)  elUnit.textContent  = unitCode;
    }

    async function fillDetailsFor(items){
        const chunks = [];
        for(let i=0;i<items.length;i+=8) chunks.push(items.slice(i,i+8));
        for(const batch of chunks){
            await Promise.allSettled(batch.map(async it=>{
                const d = await fetchDetails(it.id);
                renderCellsFromDetails(it, d);
            }));
        }
    }

    /* ===== ëª©ë¡ ë¡œë“œ (ë³µìˆ˜ í•„í„° + ID ì»¤ì„œ) ===== */
    async function loadMore(){
        if (loading || !hasNext) return;
        loading = true; show($loading);

        const params = new URLSearchParams();
        if(subjectId && subjectId !== 0){
            params.set('subjectId', subjectId);
        }
        if(Array.isArray(roundIds) && roundIds.length > 0){
            roundIds.forEach(id => {
                if(id) params.append('roundIds', id);
            });
        }
        if(Array.isArray(unitIds) && unitIds.length > 0){
            unitIds.forEach(id => {
                if(id) params.append('unitIds', id);
            });
        }
        if(q) params.set('q', q);
        if(nextId != null) params.set('cursorId', nextId);
        params.set('size', size);

        try{
            const res = await fetch(`/problems/list/api?${params.toString()}`, { method:'GET' });
            if(!res.ok) throw new Error('Network error');
            const data = await res.json(); // {items, hasNext, nextCursorId, ...}

            console.log('ğŸ”¥ ì‹¤ì œ ì„œë²„ ì‘ë‹µ êµ¬ì¡°:', data);

            if(firstLoad && (!data.items || data.items.length===0)){
                show($empty); hasNext=false; return;
            }

            const page = data.items || [];
            const newly = page.filter(it => {
                if (seenIds.has(it.id)) return false;
                seenIds.add(it.id);
                return true;
            });

            if (newly.length > 0) {
                allItems.push(...newly);
                sortItems(allItems);
                renderAll();
            }

            console.log('ğŸ”¥ [loadMore] response:', data);

            // âœ… nextCursorId ë¨¼ì € ë°˜ì˜
            nextId = (typeof data.nextCursorId !== 'undefined' && data.nextCursorId !== null)
                ? data.nextCursorId
                : null;

            let hasNextFromServer;
            if (typeof data.hasNext === 'boolean') {
                hasNextFromServer = data.hasNext;
            } else {
                hasNextFromServer = (nextId !== null);
            }
            hasNext = hasNextFromServer;

            console.log('[loadMore] nextId:', nextId, 'hasNext:', hasNext);

            show(hasNext ? null : $done);
        } catch (e){
            console.error(e);
            show(null);
        } finally {
            loading = false;
            firstLoad = false;

            if (scrollRoot
                && scrollRoot.scrollHeight <= scrollRoot.clientHeight
                && hasNext) {
                console.log('ì»¨í…Œì´ë„ˆì— ìŠ¤í¬ë¡¤ì´ ì—†ì–´ì„œ ì¶”ê°€ ë¡œë”© ì‹¤í–‰');
                setTimeout(() => {
                    if(!loading && hasNext) {
                        loadMore();
                    }
                }, 0);
            }
        }
    }

    /* ===== ì—ë””í„° ì—´ê¸°/ë‹«ê¸°/ì €ì¥ ===== */
    function toggleEditor(id, open){
        const row = document.getElementById(`code-editor-${id}`);
        if(!row) return;
        if(open){
            row.classList.remove('d-none');
            preloadCodes(id).catch(()=>{});
        } else {
            row.classList.add('d-none');
        }
    }

    async function preloadCodes(id){
        try{
            const data = await fetchDetails(id);
            if(data){
                const rp = document.getElementById(`rp-${id}`);
                const sc = document.getElementById(`sc-${id}`);
                const uc = document.getElementById(`uc-${id}`);
                const up = document.getElementById(`up-${id}`);
                if(rp && data.roundProblemNo != null) rp.value = data.roundProblemNo;
                if(sc && data.subjectCode != null) sc.value = String(data.subjectCode).padStart(2,'0').slice(-2);
                if(uc && data.unitSeqCode != null) uc.value = String(data.unitSeqCode).padStart(3,'0').slice(-3);
                if(up && data.unitProblemNo != null) up.value = data.unitProblemNo;

                bindEditorBehavior(id);
                ['rp','sc','uc','up'].forEach(k=>document.getElementById(`${k}-${id}`)?.dispatchEvent(new Event('input')));
            }
        }catch(e){}
    }

    async function saveCodes(id){
        const rp = document.getElementById(`rp-${id}`);
        const sc = document.getElementById(`sc-${id}`);
        const uc = document.getElementById(`uc-${id}`);
        const up = document.getElementById(`up-${id}`);

        const roundProblemNo = parseInt(rp?.value ?? '', 10);
        const subjectCode = (sc?.value ?? '').replace(/\D/g,'').padStart(2,'0').slice(-2);
        const unitSeqCode = (uc?.value ?? '').replace(/\D/g,'').padStart(3,'0').slice(-3);
        const unitProblemNo = parseInt(up?.value ?? '', 10);

        if(!(roundProblemNo>=1 && roundProblemNo<=40)){ alert('íšŒì°¨ ë‚´ ë²ˆí˜¸ëŠ” 1~40 ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
        if(!/^\d{2}$/.test(subjectCode)){ alert('ê³¼ëª©ì½”ë“œëŠ” 2ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
        if(!/^\d{3}$/.test(unitSeqCode)){ alert('ë‹¨ì›ì½”ë“œëŠ” 3ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }
        if(!(unitProblemNo>=1 && unitProblemNo<=99)){ alert('ë‹¨ì› ë‚´ ìˆœë²ˆì€ 1~99 ë²”ìœ„ì—¬ì•¼ í•©ë‹ˆë‹¤.'); return; }

        try{
            const res = await fetch(`/problems/${id}/codes`, withCsrf({
                method:'POST', headers:{ 'Content-Type':'application/json' },
                body: JSON.stringify({ roundProblemNo, subjectCode, unitSeqCode, unitProblemNo })
            }));
            if(!res.ok){
                const msg = await res.text();
                throw new Error(msg || 'ì €ì¥ ì‹¤íŒ¨');
            }

            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            const old = detailsCache.get(id)||{};
            const updated = { ...old, roundProblemNo, subjectCode, unitSeqCode, unitProblemNo };
            detailsCache.set(id, updated);
            renderCellsFromDetails(
                { id, roundName: document.querySelector(`#row-${id} td:nth-child(7)`)?.textContent || '' },
                updated
            );
            toggleEditor(id,false);
        }catch(e){
            console.error(e);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    /* ===== "ì „ì²´ íšŒì°¨ / ì „ì²´ ë‹¨ì›" ë²„íŠ¼ ë™ì‘ ===== */
    function selectAllRounds(){
        document.querySelectorAll("input[name='roundIds']").forEach(cb => cb.checked = false);
        document.querySelector("form.filter-form").submit();
    }
    function selectAllUnits(){
        document.querySelectorAll("input[name='unitIds']").forEach(cb => cb.checked = false);
        document.querySelector("form.filter-form").submit();
    }

    /* âœ… í˜„ì¬ í•„í„° ìš”ì•½ í…ìŠ¤íŠ¸ ê°±ì‹  */
    function updateFilterSummary(){
        const $summary = document.getElementById('filterSummary');
        if(!$summary) return;

        // ê³¼ëª©
        let subjectText = 'ì „ì²´ ê³¼ëª©';
        const subjectChecked = document.querySelector("input[name='subjectId']:checked");
        if(subjectChecked){
            const label = document.querySelector(`label[for='${subjectChecked.id}']`);
            if(label && label.textContent.trim() !== 'ì „ì²´'){
                subjectText = label.textContent.trim();
            }
        }

        // íšŒì°¨ (ë³µìˆ˜)
        const roundChecked = Array.from(document.querySelectorAll("input[name='roundIds']:checked"));
        let roundText = 'ì „ì²´ íšŒì°¨';
        if(roundChecked.length > 0){
            const names = roundChecked
                .map(cb => document.querySelector(`label[for='${cb.id}']`)?.textContent.trim())
                .filter(Boolean);
            if(names.length > 0){
                roundText = names.slice(0,3).join(', ');
                if(names.length > 3) roundText += ` ì™¸ ${names.length - 3}ê°œ`;
            }
        }

        // ë‹¨ì› (ë³µìˆ˜)
        const unitChecked = Array.from(document.querySelectorAll("input[name='unitIds']:checked"));
        let unitText = 'ì „ì²´ ë‹¨ì›';
        if(unitChecked.length > 0){
            const names = unitChecked
                .map(cb => document.querySelector(`label[for='${cb.id}']`)?.textContent.trim())
                .filter(Boolean);
            if(names.length > 0){
                unitText = names.slice(0,3).join(', ');
                if(names.length > 3) unitText += ` ì™¸ ${names.length - 3}ê°œ`;
            }
        }

        $summary.innerHTML =
            `<strong>ê³¼ëª©</strong> ${subjectText}` +
            `<span class="dot">Â·</span>` +
            `<strong>íšŒì°¨</strong> ${roundText}` +
            `<span class="dot">Â·</span>` +
            `<strong>ë‹¨ì›</strong> ${unitText}`;
    }

    /* ===== ì˜µì €ë²„ & ìµœì´ˆ ë¡œë“œ ===== */
    const scrollRoot = document.getElementById('scrollRoot');
    const sentinel   = document.getElementById('sentinel');

    const io = new IntersectionObserver((entries)=>{
        entries.forEach(entry=>{
            if(entry.isIntersecting){
                loadMore();
            }
        });
    }, {
        root: null,
        rootMargin: '0px 0px 400px 0px',
        threshold: 0
    });

    document.addEventListener('DOMContentLoaded', ()=>{
        io.observe(sentinel);
        fetchCount();
        loadMore();
        updateFilterSummary();

        const filterForm = document.querySelector('form.filter-form');
        if(filterForm){
            filterForm.addEventListener('change', ()=>{
                updateFilterSummary();
            });
        }
    });
</script>
</body>
</html>
