<!-- src/main/resources/templates/problems/solve.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>기출문제 풀이 | 공인중개사 기출모아</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root{
            --color-main:#2F4858; --color-sub:#4F7CAC; --color-point:#F5CD90;
            --text-main:#2C3E3F; --text-sub:#7A746E; --bg:#F4F3F1; --white:#fff;
            --radius-lg:20px; --radius-md:14px;
            --shadow-sm:0 6px 18px rgba(47,72,88,.10); --shadow-xs:0 3px 10px rgba(47,72,88,.08);
            --maxw:1100px;
        }
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--text-main);font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.2px}
        .btn-main{background:var(--color-main);color:#fff;border:none}.btn-main:hover{filter:brightness(.95)}
        .btn-sub{color:var(--color-sub);border:1.5px solid var(--color-sub);background:transparent}.btn-sub:hover{background:rgba(79,124,172,.08)}
        .btn-ghost{border:1px solid #d9dde2;background:#fff;color:var(--text-main)}
        .chip{display:inline-flex;align-items:center;gap:8px;background:#e9eef3;color:var(--color-main);border-radius:999px;padding:6px 12px;font-weight:700;font-size:.9rem}
        .cardx{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:20px}
        .viewer-header{position:sticky;top:0;z-index:3;background:var(--white);box-shadow:var(--shadow-sm);padding:14px 16px}
        .vh-wrap{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
        .vh-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .vh-title{font-weight:900;letter-spacing:.3px;color:var(--color-main)}
        .select-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .dropdown-menu{border-radius:12px;box-shadow:var(--shadow-xs);border:1px solid #e5e7ea;max-height:260px;overflow-y:auto;}
        .counter-badge{border:1.5px solid var(--color-sub);color:var(--color-sub);background:#fff;font-weight:800}
        .container-wrap{max-width:var(--maxw);margin:18px auto;padding:0 12px}
        #main .list-group-item{border-radius:12px;margin-bottom:8px;border:1px solid #e8ebef}
        .question-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px}
        .nav-group .btn{border-radius:999px}
        .question-box{background:#fff;border:1px solid #e5e7ea;border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-xs)}
        #question-title{font-size:1.1rem;font-weight:800;color:var(--text-main)}
        #choices .list-group-item{border:1px solid #e6eaee;border-radius:14px;margin-bottom:10px;padding:12px 14px;display:block}
        .form-check.custom-radio .form-check-input{display:none}
        .form-check.custom-radio .form-check-label{position:relative;padding-left:40px;cursor:pointer;width:100%}
        .form-check.custom-radio .form-check-label:before{content:attr(data-number);position:absolute;left:0;top:50%;transform:translateY(-50%);width:28px;height:28px;border:2px solid var(--color-sub);border-radius:50%;text-align:center;line-height:24px;font-weight:800;color:var(--color-sub);background:#fff}
        .form-check.custom-radio .form-check-input:checked + .form-check-label:before{background:var(--color-main);color:#fff;border-color:var(--color-main)}
        .choice-correct{border-color:#2e7d32!important;box-shadow:0 0 0 3px rgba(46,125,50,.08)}
        .choice-wrong{border-color:#c62828!important;box-shadow:0 0 0 3px rgba(198,40,40,.08)}
        #choices li.disabled-choice{color:#9aa1a6;background:linear-gradient(0deg,rgba(0,0,0,.02),rgba(0,0,0,.02))}
        #solution-area{background:#fff;border:1px solid #e5e7ea;border-radius:16px;padding:16px}
        #solution-area h5{color:var(--color-main);font-weight:900}
        .solution-pill{background:var(--color-point);color:#4d3a16;font-weight:900;padding:4px 10px;border-radius:999px;margin-left:8px}
    </style>
</head>
<body>

<header class="viewer-header">
    <div class="vh-wrap">
        <div class="vh-left">
            <span class="vh-title">기출문제 풀이</span>
            <span id="question-count-top" class="chip">0 / 0</span>
        </div>
        <div class="select-row">
            <!-- 과목 -->
            <div class="dropdown">
                <button class="btn btn-ghost dropdown-toggle" type="button" id="subjectDropdown" data-bs-toggle="dropdown">과목 선택</button>
                <ul class="dropdown-menu" id="subject-menu"></ul>
            </div>
            <!-- 회차 -->
            <div class="dropdown" data-bs-auto-close="false">
                <button class="btn btn-ghost dropdown-toggle" type="button" id="roundDropdown" data-bs-toggle="dropdown">회차 선택</button>
                <ul class="dropdown-menu" id="round-menu"></ul>
            </div>
            <!-- 단원 -->
            <div class="dropdown" data-bs-auto-close="false">
                <button class="btn btn-ghost dropdown-toggle" type="button" id="unitDropdown" data-bs-toggle="dropdown">단원 선택</button>
                <ul class="dropdown-menu" id="unit-menu"></ul>
            </div>
            <span id="question-count" class="btn counter-badge disabled">0 / 0</span>
            <button id="start-btn" class="btn btn-main">문제풀기</button>
        </div>
    </div>
</header>

<div class="container-wrap" id="main">
    <div class="cardx">
        <h3 class="mb-3" style="color:var(--color-main);font-weight:900;">진행중인 문제풀이</h3>
        <div class="list-group" id="session-list"></div>
        <div class="small text-muted">※ 로그인 사용자 전용 기능입니다.</div>
    </div>
</div>

<div class="container-wrap" id="question-area" style="display:none;">
    <div class="cardx">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="question-top nav-group btn-group">
                <button id="prev-btn" class="btn btn-sub">◀</button>
                <button id="problem-btn" class="btn btn-ghost">문제</button>
                <button id="solution-btn" class="btn btn-ghost">해설</button>
                <button id="next-btn" class="btn btn-sub">▶</button>
            </div>
        </div>
        <div class="mb-2"><span class="chip">진행 <strong id="qc-top">0 / 0</strong></span></div>
        <p id="question-title" class="mb-2"></p>
        <div id="question-text" class="mb-3 question-box"></div>
        <ul id="choices" class="list-group mb-3"></ul>
        <div id="solution-area" class="mb-2" style="display:none;">
            <h5 class="mb-2">해설 <span class="solution-pill" id="sol-answer-pill">정답: -</span></h5>
            <p id="solution-text" class="mb-0"></p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let items=[], currentIndex=0, selectedSubject=null, selectedRounds=[], selectedUnits=[], roundData=[];
    let sessionId=null;

    document.addEventListener("DOMContentLoaded", () => {
        loadSubjects();
        bindUI();
    });

    function syncCounts(current,total){
        const a=`${current} / ${total}`;
        ['question-count','question-count-top','qc-top'].forEach(id=>{
            const el=document.getElementById(id); if(el) el.textContent=a;
        });
    }

    /* ===== 과목 ===== */
    async function loadSubjects(){
        try{
            const res=await axios.get('/problems/api/subjects');
            const menu=document.getElementById('subject-menu'); menu.innerHTML='';
            res.data.forEach(it=>{
                const li=document.createElement('li');
                li.innerHTML=`<a class="dropdown-item" href="#" data-id="${it.id}">${it.name}</a>`;
                menu.appendChild(li);
            });
            menu.querySelectorAll('.dropdown-item').forEach(a=>{
                a.addEventListener('click',async e=>{
                    e.preventDefault();
                    selectedSubject=Number(e.target.dataset.id);
                    document.getElementById('subjectDropdown').textContent=e.target.textContent;
                    await loadRounds(selectedSubject);
                    await loadUnits(selectedSubject);
                    updateQuestionCount();
                });
            });
        }catch(err){ console.error('과목 로딩 실패:',err); }
    }

    /* ===== 회차 ===== */
    async function loadRounds(subjectId){
        selectedRounds=[]; roundData=[];
        const menu=document.getElementById('round-menu');
        menu.innerHTML=`
            <li><div class="text-center py-2">
                <button class="btn btn-sm btn-main w-100" id="round-confirm-btn">확인</button>
            </div></li>
            <li><label class="dropdown-item"><input type="checkbox" id="round-select-all"> 전체 선택</label></li>`;
        try{
            const res=await axios.get(`/problems/api/rounds?subjectId=${subjectId}`);
            roundData=res.data;
            res.data.sort((a,b)=>a.roundNumber-b.roundNumber).forEach(r=>{
                const li=document.createElement('li');
                li.innerHTML=`<label class="dropdown-item"><input type="checkbox" class="round-cb" value="${r.id}"> ${r.name}</label>`;
                menu.appendChild(li);
            });

            const allCb=document.getElementById("round-select-all");
            const getCbs=()=>menu.querySelectorAll(".round-cb");

            allCb.addEventListener("change",()=>{ getCbs().forEach(cb=>cb.checked=allCb.checked); });

            document.getElementById("round-confirm-btn").addEventListener("click",()=>{
                const list=[...getCbs()].filter(x=>x.checked).map(x=>Number(x.value));
                if(allCb.checked || list.length===0){
                    selectedRounds=[];
                    document.getElementById("roundDropdown").textContent="전체 회차";
                }else if(list.length===1){
                    const r=roundData.find(x=>x.id===list[0]);
                    document.getElementById("roundDropdown").textContent=r? r.name : "회차 선택";
                    selectedRounds=list;
                }else{
                    selectedRounds=list;
                    document.getElementById("roundDropdown").textContent="다중 회차";
                }
                updateQuestionCount();
            });
        }catch(err){ console.error('회차 로딩 실패:',err); }
    }

    /* ===== 단원 ===== */
    async function loadUnits(subjectId){
        selectedUnits=[];
        const menu=document.getElementById('unit-menu');
        menu.innerHTML=`
            <li><div class="text-center py-2">
                <button class="btn btn-sm btn-main w-100" id="unit-confirm-btn">확인</button>
            </div></li>
            <li><label class="dropdown-item"><input type="radio" name="unitRadio" value="all" checked> 전체 선택</label></li>`;
        try{
            const res=await axios.get(`/problems/api/units?subjectId=${subjectId}`);
            res.data.forEach(u=>{
                const li=document.createElement('li');
                li.innerHTML=`<label class="dropdown-item"><input type="radio" name="unitRadio" value="${u.id}"> ${u.name}</label>`;
                menu.appendChild(li);
            });

            document.getElementById("unit-confirm-btn").addEventListener("click",()=>{
                const checked=menu.querySelector("input[name=unitRadio]:checked");
                if(!checked || checked.value==="all"){
                    selectedUnits=[];
                    document.getElementById("unitDropdown").textContent="전체 단원";
                }else{
                    selectedUnits=[Number(checked.value)];
                    document.getElementById("unitDropdown").textContent=checked.parentElement.textContent.trim();
                }
                updateQuestionCount();
            });
        }catch(err){ console.error('단원 로딩 실패:',err); }
    }

    /* ===== 문제 개수 카운트 ===== */
    async function updateQuestionCount(){
        if(!selectedSubject) return;
        try{
            const params={subjectId:selectedSubject};
            if(selectedRounds.length>0) params.roundIds=selectedRounds;
            if(selectedUnits.length>0) params.unitIds=selectedUnits;

            const res=await axios.get("/problems/api/problems/count",{
                params,
                paramsSerializer: p=>{
                    const usp=new URLSearchParams();
                    Object.keys(p).forEach(k=>{
                        const v=p[k];
                        if(Array.isArray(v)){ v.forEach(val=>usp.append(k,val)); }
                        else if(v!==undefined && v!==null){ usp.append(k,v); }
                    });
                    return usp.toString();
                }
            });
            syncCounts(0,res.data.count);
        }catch(err){ console.error("문제 개수 조회 실패:",err); }
    }

    /* ===== 문제풀기 시작 ===== */
    async function startPractice(){
        if(!selectedSubject){ alert("과목을 선택하세요."); return; }
        try{
            const res=await axios.post("/problems/practice/start",{
                subjectId:selectedSubject, roundIds:selectedRounds, unitIds:selectedUnits
            });
            items=res.data.firstPage; sessionId=res.data.sessionId;
            currentIndex=0;
            if(items.length===0){ alert("문제가 없습니다."); return; }
            document.getElementById("main").style.display="none";
            document.getElementById("question-area").style.display="block";
            renderQuestion();
        }catch(err){ console.error("세션 시작 실패:",err); }
    }

    /* ===== 문제 렌더링 ===== */
    function renderQuestion(){
        const q=items[currentIndex]; if(!q) return;
        document.getElementById("question-title").textContent=q.title;
        document.getElementById("question-text").innerHTML=q.viewContent||"";
        const ul=document.getElementById("choices"); ul.innerHTML="";
        q.choices.forEach((c,i)=>{
            if(!c) return;
            const li=document.createElement("li");
            li.className="list-group-item";
            li.innerHTML=`<div class="form-check custom-radio">
                <input class="form-check-input" type="radio" name="choice" id="choice${i+1}">
                <label class="form-check-label" for="choice${i+1}" data-number="${i+1}">${c}</label>
            </div>`;
            ul.appendChild(li);
            li.querySelector("input").addEventListener("change",()=>submitAnswer(q.itemId,i+1));
        });
        document.getElementById("solution-area").style.display="none";
        syncCounts(currentIndex+1,items.length);
    }

    /* ===== 정답 제출 ===== */
    async function submitAnswer(itemId,choiceNo){
        try{
            const res=await axios.post("/problems/practice/answer",{ sessionId, itemId, selected:choiceNo });
            const correct=res.data.correct;
            showResult(choiceNo,correct,res.data.answer,res.data.explanation);
        }catch(err){ console.error("정답 제출 실패:",err); }
    }
    function showResult(choiceNo,correct,answer,exp){
        const list=document.querySelectorAll("#choices .list-group-item");
        list.forEach((li,i)=>{
            if(i+1===choiceNo){ li.classList.add(correct?"choice-correct":"choice-wrong"); }
            if(i+1===answer){ li.classList.add("choice-correct"); }
        });
        document.getElementById("solution-area").style.display="block";
        document.getElementById("sol-answer-pill").textContent=`정답: ${answer}`;
        document.getElementById("solution-text").textContent=exp||"";
    }

    /* ===== 이전/다음 ===== */
    function prevQuestion(){ if(currentIndex>0){ currentIndex--; renderQuestion(); } }
    function nextQuestion(){ if(currentIndex<items.length-1){ currentIndex++; renderQuestion(); } }

    /* ===== 바인딩 ===== */
    function bindUI(){
        document.getElementById("start-btn").addEventListener("click",startPractice);
        document.getElementById("prev-btn").addEventListener("click",prevQuestion);
        document.getElementById("next-btn").addEventListener("click",nextQuestion);
        document.getElementById("problem-btn").addEventListener("click",()=>{
            document.getElementById("question-text").style.display="block";
            document.getElementById("solution-area").style.display="none";
        });
        document.getElementById("solution-btn").addEventListener("click",()=>{
            document.getElementById("solution-area").style.display="block";
        });
    }
</script>
</body>
</html>
