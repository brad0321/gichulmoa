<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>기출문제 풀이 | 공인중개사 기출모아</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root{
            --color-main:#2F4858; --color-sub:#4F7CAC; --color-point:#F5CD90;
            --text-main:#2C3E3F; --text-sub:#7A746E; --bg:#F4F3F1; --white:#fff;
            --radius-lg:20px; --radius-md:14px;
            --shadow-sm:0 6px 18px rgba(47,72,88,.10); --shadow-xs:0 3px 10px rgba(47,72,88,.08);
            --maxw:1100px;
        }
        html,body{height:100%}
        body{margin:0;background:var(--bg);color:var(--text-main);font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;letter-spacing:.2px}
        .btn-main{background:var(--color-main);color:#fff;border:none}.btn-main:hover{filter:brightness(.95)}
        .btn-sub{color:var(--color-sub);border:1.5px solid var(--color-sub);background:transparent}.btn-sub:hover{background:rgba(79,124,172,.08)}
        .btn-ghost{border:1px solid #d9dde2;background:#fff;color:var(--text-main)}
        .chip{display:inline-flex;align-items:center;gap:8px;background:#e9eef3;color:var(--color-main);border-radius:999px;padding:6px 12px;font-weight:700;font-size:.9rem}
        .cardx{background:#fff;border-radius:var(--radius-lg);box-shadow:var(--shadow-sm);padding:20px}
        .viewer-header{position:sticky;top:0;z-index:3;background:var(--white);box-shadow:var(--shadow-sm);padding:14px 16px}
        .vh-wrap{max-width:var(--maxw);margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
        .vh-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
        .vh-title{font-weight:900;letter-spacing:.3px;color:var(--color-main)}
        .select-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .panel-box{position:absolute;bottom:100%;left:0;width:280px;background:#fff;border:1px solid #e5e7ea;border-radius:14px;padding:14px;display:none;z-index:1000;box-shadow:var(--shadow-xs)}
        .panel-box label{display:flex;align-items:center;gap:8px;font-size:.95rem;margin-bottom:8px;color:var(--text-main)}
        .panel-box .btn{font-size:.9rem;padding:5px 12px}
        .select-holder{position:relative}
        .dropdown-menu{border-radius:12px;box-shadow:var(--shadow-xs);border:1px solid #e5e7ea;max-height:260px;overflow-y:auto;}
        .counter-badge{border:1.5px solid var(--color-sub);color:var(--color-sub);background:#fff;font-weight:800}
        .container-wrap{max-width:var(--maxw);margin:18px auto;padding:0 12px}
        #main .list-group-item{border-radius:12px;margin-bottom:8px;border:1px solid #e8ebef}
        .question-top{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:12px}
        .nav-group .btn{border-radius:999px}
        .question-box{background:#fff;border:1px solid #e5e7ea;border-radius:var(--radius-lg);padding:18px;box-shadow:var(--shadow-xs)}
        #question-title{font-size:1.1rem;font-weight:800;color:var(--text-main)}
        #choices .list-group-item{border:1px solid #e6eaee;border-radius:14px;margin-bottom:10px;padding:12px 14px;display:block}
        .form-check.custom-radio .form-check-input{display:none}
        .form-check.custom-radio .form-check-label{position:relative;padding-left:40px;cursor:pointer;width:100%}
        .form-check.custom-radio .form-check-label:before{content:attr(data-number);position:absolute;left:0;top:50%;transform:translateY(-50%);width:28px;height:28px;border:2px solid var(--color-sub);border-radius:50%;text-align:center;line-height:24px;font-weight:800;color:var(--color-sub);background:#fff}
        .form-check.custom-radio .form-check-input:checked + .form-check-label:before{background:var(--color-main);color:#fff;border-color:var(--color-main)}
        .choice-correct{border-color:#2e7d32!important;box-shadow:0 0 0 3px rgba(46,125,50,.08)}
        .choice-wrong{border-color:#c62828!important;box-shadow:0 0 0 3px rgba(198,40,40,.08)}
        #choices li.disabled-choice{color:#9aa1a6;background:linear-gradient(0deg,rgba(0,0,0,.02),rgba(0,0,0,.02))}
        .mark-o{color:#2e7d32;font-weight:800;margin-left:8px}
        .mark-x{color:#c62828;font-weight:800;margin-left:8px}
        .clickable-word{position:relative;cursor:pointer;font-weight:900;color:var(--color-main);padding:2px 6px;border-radius:8px;border-bottom:2px dotted var(--color-sub)}
        .clickable-word.selected-o{background:rgba(46,125,50,.08)}
        .clickable-word.selected-o::after{content:"O";color:#2e7d32;font-size:18px;position:absolute;top:-10px;left:50%;transform:translateX(-50%)}
        .clickable-word.selected-x{background:rgba(198,40,40,.08)}
        .clickable-word.selected-x::after{content:"X";color:#c62828;font-size:18px;position:absolute;top:-10px;left:50%;transform:translateX(-50%)}
        #solution-area{background:#fff;border:1px solid #e5e7ea;border-radius:16px;padding:16px}
        #solution-area h5{color:var(--color-main);font-weight:900}
        .solution-pill{background:var(--color-point);color:#4d3a16;font-weight:900;padding:4px 10px;border-radius:999px;margin-left:8px}
    </style>
</head>
<body>

<!-- ===== 상단 헤더 ===== -->
<header class="viewer-header">
    <div class="vh-wrap">
        <div class="vh-left">
            <span class="vh-title">기출문제 풀이</span>
            <span id="question-count-top" class="chip">0 / 0</span>
        </div>

        <div class="select-row">
            <!-- 과목 -->
            <div class="dropdown">
                <button class="btn btn-ghost dropdown-toggle" type="button" id="subjectDropdown" data-bs-toggle="dropdown" aria-expanded="false">과목 선택</button>
                <ul class="dropdown-menu" id="subject-menu" style="max-height:260px;overflow-y:auto;"></ul>
            </div>

            <!-- 회차 -->
            <div class="dropdown" data-bs-auto-close="false">
                <button class="btn btn-ghost dropdown-toggle" type="button" id="roundDropdown" data-bs-toggle="dropdown" aria-expanded="false">회차 선택</button>
                <ul class="dropdown-menu" id="round-menu"></ul>
            </div>

            <!-- 단원 -->
            <div class="dropdown" data-bs-auto-close="outside">
                <button class="btn btn-ghost dropdown-toggle" type="button" id="unitDropdown" data-bs-toggle="dropdown" aria-expanded="false">단원 선택</button>
                <ul class="dropdown-menu" id="unit-menu"></ul>
            </div>

            <span id="question-count" class="btn counter-badge disabled">0 / 0</span>
            <button id="start-btn" class="btn btn-main">문제풀기</button>

            <!-- 확대/축소 -->
            <div class="btn-group" role="group" aria-label="zoom">
                <button class="btn btn-ghost btn-sm" id="zoom-in-btn">+</button>
                <button class="btn btn-ghost btn-sm" id="zoom-out-btn">-</button>
            </div>

            <!-- 설정 (회원 전용 링크는 userId>0일 때만 노출) -->
            <div class="select-holder">
                <button class="btn btn-ghost btn-sm" id="settings-btn">설정 ⚙</button>
                <div id="settings-panel" class="panel-box" style="right:0;left:auto;">
                    <a class="d-block mb-1 text-decoration-none" th:if="${userId > 0}" th:href="@{/wrong-notes(userId=${userId})}">오답노트</a>
                    <a class="d-block mb-1 text-decoration-none" th:if="${userId > 0}" th:href="@{/score-stats/user(userId=${userId})}">점수통계</a>
                    <a class="d-block mb-1 text-decoration-none" th:href="@{/guide}">사용설명</a>
                    <a class="d-block mb-1 text-decoration-none" th:href="@{/exam-schedule}">시험일정</a>
                    <a class="d-block mb-1 text-decoration-none" th:href="@{/members/mypage}">마이페이지</a>
                    <a class="d-block mb-1 text-decoration-none" th:if="${userId == 0}" th:href="@{/login}">로그인</a>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- 진행중 목록(필요시) -->
<div class="container-wrap" id="main">
    <div class="cardx">
        <h3 class="mb-3" style="color:var(--color-main);font-weight:900;">진행중인 문제풀이</h3>
        <div class="list-group" id="session-list"></div>
        <div class="small text-muted">※ 로그인 사용자 전용 기능입니다.</div>
    </div>
</div>

<!-- 문제 풀이 영역 -->
<div class="container-wrap" id="question-area" style="display:none;">
    <div class="cardx">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="question-top nav-group btn-group">
                <button id="prev-btn" class="btn btn-sub">◀</button>
                <button id="problem-btn" class="btn btn-ghost">문제</button>
                <button id="solution-btn" class="btn btn-ghost">해설</button>
                <button id="next-btn" class="btn btn-sub">▶</button>
            </div>
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="wrong-checkbox">
                <label class="form-check-label" for="wrong-checkbox">오답노트</label>
            </div>
        </div>

        <div class="mb-2"><span class="chip">진행 <strong id="qc-top">0 / 0</strong></span></div>
        <p id="question-title" class="mb-2"></p>
        <div id="question-text" class="mb-3 question-box"></div>
        <ul id="choices" class="list-group mb-3"></ul>

        <div id="solution-area" class="mb-2" style="display:none;">
            <h5 class="mb-2">해설 <span class="solution-pill" id="sol-answer-pill">정답: -</span></h5>
            <p id="solution-text" class="mb-0"></p>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* ===== state ===== */
    let items=[], currentIndex=0, selectedSubject=null, selectedRounds=[], selectedUnits=[];
    let userAnswers=[], checkedStates=[], markMode=null, sessionId=null;

    document.addEventListener("DOMContentLoaded", () => {
        loadSubjects();
    });

    function syncCounts(current,total){
        const a=`${current} / ${total}`;
        ['question-count','question-count-top','qc-top'].forEach(id=>{
            const el=document.getElementById(id); if(el) el.textContent=a;
        });
    }
    function makeYearByRound(r){ return 2024 - (35 - r); } // 필요시 조정

    /* ===== subjects ===== */
    async function loadSubjects(){
        try{
            const res=await axios.get('/problems/api/subjects');
            const menu=document.getElementById('subject-menu'); menu.innerHTML='';

            res.data.forEach(it=>{
                const li=document.createElement('li');
                li.innerHTML=`<a class="dropdown-item" href="#" data-id="${it.id}">${it.name}</a>`;
                menu.appendChild(li);
            });

            document.querySelectorAll('#subject-menu .dropdown-item').forEach(a=>{
                a.addEventListener('click', async (e)=>{
                    e.preventDefault();
                    selectedSubject=e.target.dataset.id;
                    document.getElementById('subjectDropdown').textContent=e.target.textContent;
                    await loadRounds(selectedSubject); await loadUnits(selectedSubject); updateQuestionCount();
                });
            });
        }catch(err){ console.error('과목 로딩 실패:',err); }
    }

    /* ===== rounds ===== */
    async function loadRounds(subjectId){
        selectedRounds=[];
        const menu=document.getElementById('round-menu');
        menu.innerHTML='';
        let rounds=[];
        try{
            const res=await axios.get(`/problems/api/rounds?subjectId=${subjectId}`);
            rounds=res.data.length>0 ? res.data.map(r=>({id:r.id, number:r.roundNumber}))
                : Array.from({length:10},(_,i)=>({id:String(26+i), number:26+i}));
        }catch(err){
            console.error('회차 로딩 실패:',err);
            rounds=Array.from({length:10},(_,i)=>({id:String(26+i), number:26+i}));
        }
        rounds.sort((a,b)=>a.number-b.number).forEach(r=>{
            const year=makeYearByRound(r.number);
            const li=document.createElement('li');
            li.innerHTML=`<label class="dropdown-item"><input type="checkbox" value="${r.id}" data-number="${r.number}"> ${r.number}회차 (${year}년)</label>`;
            menu.appendChild(li);
        });

        const liAll=document.createElement('li');
        liAll.innerHTML=`<label class="dropdown-item"><input type="checkbox" id="round-all"> 전체회차</label>`;
        menu.appendChild(liAll);

        const liBtn=document.createElement('li');
        liBtn.innerHTML=`<div class="d-flex justify-content-between px-3 py-2 border-top">
                <button id="round-confirm" class="btn btn-sm btn-main">확인</button>
                <button id="round-close" class="btn btn-sm btn-ghost">닫기</button>
            </div>`;
        menu.appendChild(liBtn);

        menu.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
            cb.addEventListener('change',()=>{
                if(cb.id==='round-all'){
                    const checked=cb.checked;
                    menu.querySelectorAll('input[type="checkbox"]:not(#round-all)').forEach(x=>x.checked=checked);
                }else{
                    const all=document.getElementById('round-all');
                    if(!cb.checked && all) all.checked=false;
                }
            });
        });

        document.getElementById('round-confirm').addEventListener('click',()=>{
            const checked=[...menu.querySelectorAll('input[type="checkbox"]:not(#round-all)')].filter(cb=>cb.checked).map(cb=>cb.value);
            selectedRounds=checked;
            const total=menu.querySelectorAll('input[type="checkbox"]:not(#round-all)').length;
            const all=document.getElementById('round-all');
            if(all) all.checked=checked.length===total;
            updateRoundText();
            updateQuestionCount();
            const dd=bootstrap.Dropdown.getInstance(document.getElementById('roundDropdown'));
            dd && dd.hide();
        });
        document.getElementById('round-close').addEventListener('click',()=>{
            menu.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
                if(cb.id==='round-all'){
                    const total=menu.querySelectorAll('input[type="checkbox"]:not(#round-all)').length;
                    cb.checked=selectedRounds.length===total && total>0;
                }else{
                    cb.checked=selectedRounds.includes(cb.value);
                }
            });
            const dd=bootstrap.Dropdown.getInstance(document.getElementById('roundDropdown'));
            dd && dd.hide();
        });

        updateRoundText();
    }

    function updateRoundText(){
        const allChecked=document.getElementById('round-all')?.checked;
        const checked=[...document.querySelectorAll('#round-menu input[type="checkbox"]:not(#round-all)')].filter(cb=>cb.checked);
        let text='회차 선택';
        if(allChecked) text='전체회차';
        else if(checked.length>1) text='다중회차';
        else if(checked.length===1) text=`${checked[0].dataset.number}회차`;
        document.getElementById('roundDropdown').textContent=text;
    }

    /* ===== units ===== */
    async function loadUnits(subjectId){
        selectedUnits=[];
        const menu=document.getElementById('unit-menu');
        menu.innerHTML='';
        const units=[
            {id:'1', name:'부동산의 개념과 분류'},
            {id:'2', name:'부동산의 특성(속성)'},
            {id:'3', name:'부동산 경제론'},
            {id:'4', name:'부동산 시장론'},
            {id:'5', name:'부동산입지론과 공간구조론'},
            {id:'6', name:'부동산 정책론'},
            {id:'7', name:'부동산 투자론'},
            {id:'8', name:'부동산 금융론'},
            {id:'9', name:'부동산 개발론'},
            {id:'10', name:'부동산 관리론'},
            {id:'11', name:'부동산 마케팅론'},
            {id:'12', name:'감정평가의 기초이론'},
            {id:'13', name:'감정평가 3방식 7방법'},
            {id:'14', name:'부동산가격 공시제도'},
            {id:'15', name:'법률사실'},
            {id:'16', name:'법률행위'},
            {id:'17', name:'의사표시'},
            {id:'18', name:'대리행위'},
            {id:'19', name:'무효와 취소'},
            {id:'20', name:'조건과 기한'},
            {id:'21', name:'물권법 일반'},
            {id:'22', name:'물권의 변동'},
            {id:'23', name:'점유권'},
            {id:'24', name:'소유권'},
            {id:'25', name:'용익물권'},
            {id:'26', name:'담보물권'},
            {id:'27', name:'계약법 총론'},
            {id:'28', name:'매매'},
            {id:'29', name:'임대차'},
            {id:'30', name:'주택임대차보호법'},
            {id:'31', name:'상가건물임대차보호법'},
            {id:'32', name:'가등기담보'},
            {id:'33', name:'집합건물법'},
            {id:'34', name:'명의신탁'},

        ];

        const liAll=document.createElement('li');
        liAll.innerHTML=`<label class="dropdown-item"><input type="checkbox" id="unit-all"> 전체 단원</label>`;
        menu.appendChild(liAll);

        units.forEach(u=>{
            const li=document.createElement('li');
            li.innerHTML=`<label class="dropdown-item"><input type="checkbox" value="${u.id}"> ${u.name}</label>`;
            menu.appendChild(li);
        });

        const liBtn=document.createElement('li');
        liBtn.innerHTML=`<div class="d-flex justify-content-between px-3 py-2 border-top">
                <button id="unit-confirm" class="btn btn-sm btn-main">확인</button>
                <button id="unit-close" class="btn btn-sm btn-ghost">닫기</button>
            </div>`;
        menu.appendChild(liBtn);

        menu.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
            cb.addEventListener('change',()=>{
                if(cb.id==='unit-all'){
                    const checked=cb.checked;
                    menu.querySelectorAll('input[type="checkbox"]:not(#unit-all)').forEach(x=>x.checked=checked);
                }else{
                    const all=document.getElementById('unit-all');
                    if(!cb.checked && all) all.checked=false;
                }
            });
        });

        document.getElementById('unit-confirm').addEventListener('click',()=>{
            const checked=[...menu.querySelectorAll('input[type="checkbox"]:not(#unit-all)')].filter(cb=>cb.checked).map(cb=>cb.value);
            selectedUnits=checked;
            const total=menu.querySelectorAll('input[type="checkbox"]:not(#unit-all)').length;
            const all=document.getElementById('unit-all');
            if(all) all.checked=checked.length===total;
            updateUnitText();
            updateQuestionCount();
            const dd=bootstrap.Dropdown.getInstance(document.getElementById('unitDropdown'));
            dd && dd.hide();
        });
        document.getElementById('unit-close').addEventListener('click',()=>{
            menu.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
                if(cb.id==='unit-all'){
                    const total=menu.querySelectorAll('input[type="checkbox"]:not(#unit-all)').length;
                    cb.checked=selectedUnits.length===total && total>0;
                }else{
                    cb.checked=selectedUnits.includes(cb.value);
                }
            });
            const dd=bootstrap.Dropdown.getInstance(document.getElementById('unitDropdown'));
            dd && dd.hide();
        });

        updateUnitText();
    }

    function updateUnitText(){
        const allChecked=document.getElementById('unit-all')?.checked;
        const checked=[...document.querySelectorAll('#unit-menu input[type="checkbox"]:not(#unit-all)')].filter(cb=>cb.checked);
        let text='단원 선택';
        if(allChecked) text='전체 단원';
        else if(checked.length>1) text='다중 단원';
        else if(checked.length===1) text=`${checked[0].parentElement.textContent.trim()}`;
        document.getElementById('unitDropdown').textContent=text;
    }

    /* ===== count ===== */
    async function updateQuestionCount(){
        if(!selectedSubject){ syncCounts(0,0); return; }
        const params={ subjectId:selectedSubject };
        if(selectedRounds.length>0) params.roundIds=selectedRounds.join(',');
        if(selectedUnits.length>0) params.unitIds=selectedUnits.join(',');
        const res=await axios.get('/problems/api/problems',{params});
        syncCounts(0,res.data.length);
    }

    /* ===== start & render ===== */
    async function startSolving(){
        if(!selectedSubject){ alert('과목을 선택하세요.'); return; }
        document.getElementById('main').style.display='none';
        document.getElementById('question-area').style.display='block';

        const payload={ subjectId:+selectedSubject,
            roundIds:selectedRounds.map(Number) };
        if(selectedUnits.length>0) payload.unitIds=selectedUnits.map(Number);

        try{
            const res=await axios.post('/problems/practice/start', payload);
            sessionId = res.data.sessionId;
            items     = res.data.firstPage || [];
            if(items.length===0){ alert('문항이 없습니다.'); return; }
            currentIndex=0;
            showQuestion(currentIndex);
        }catch(e){
            console.error(e); alert('세션 시작 실패: 로그인 필요 또는 서버 오류');
            document.getElementById('main').style.display='block';
            document.getElementById('question-area').style.display='none';
        }
    }
    document.getElementById('start-btn').addEventListener('click',startSolving);

    function showQuestion(index){
        const q=items[index]; markMode=null;
        document.getElementById('question-title').innerHTML=`<strong>${q.title||''}</strong>`;
        document.getElementById('question-text').innerHTML=`<div>${q.viewContent||''}</div>${q.imageUrl?`<img src="${q.imageUrl}" style="max-width:100%;margin-top:10px;border-radius:12px;">`:''}`;
        markKeywords();

        const ul=document.getElementById('choices'); ul.innerHTML='';
        (q.choices||[]).forEach((content,idx)=>{
            const li=document.createElement('li'); li.className='list-group-item';
            const num=idx+1;
            li.innerHTML=`<div class="form-check custom-radio">
          <input class="form-check-input" type="radio" name="choice" id="choice-${num}" value="${num}">
          <label class="form-check-label" for="choice-${num}" data-number="${num}">
              <span class="choice-text">${content||''}</span>
          </label></div>`;
            const input=li.querySelector('input');
            input.addEventListener('change', ()=>submitImmediate(num));
            li.querySelector('.choice-text').addEventListener('click',(ev)=>{ev.preventDefault();ev.stopPropagation(); if(!markMode)return; toggleChoiceMark(li, num);});
            ul.appendChild(li);
        });

        document.getElementById('solution-area').style.display='none';
        document.getElementById('solution-text').textContent='';
        document.getElementById('sol-answer-pill').textContent=`정답: ${q.answer ?? '-'}`;

        syncCounts(index+1, items.length);

        const saved=userAnswers[index];
        if(saved){
            const radio=document.querySelector(`input[name="choice"][value="${saved}"]`);
            if(radio) radio.checked=true;
            if(checkedStates[index]) highlightAnswer(saved, q.answer);
        }
    }

    async function submitImmediate(choiceNo){
        const cur = items[currentIndex];
        try{
            const r=await axios.post('/problems/practice/answer', {
                sessionId, itemId: cur.itemId, selected: choiceNo
            });
            userAnswers[currentIndex] = choiceNo;
            checkedStates[currentIndex] = true;

            highlightAnswer(choiceNo, r.data.answer);
            document.getElementById('solution-text').textContent =
                r.data.explanation ? r.data.explanation : (r.data.correct ? '정답입니다.' : '오답입니다.');
            document.getElementById('sol-answer-pill').textContent = `정답: ${r.data.answer ?? '-'}`;
            document.getElementById('solution-area').style.display='block';
        }catch(e){ console.error('채점 실패', e); }
    }

    function highlightAnswer(selected, answer){
        document.querySelectorAll('#choices .list-group-item').forEach((li,idx)=>{
            li.classList.remove('choice-correct','choice-wrong');
            const num=idx+1;
            if(num===selected){ li.classList.add(selected===answer?'choice-correct':'choice-wrong'); }
        });
    }

    /* ===== keyword mark & elimination ===== */
    function markKeywords(){
        const reps=[{kw:'옳은',type:'o'},{kw:'모두 고른 것',type:'o'},{kw:'해야 하는 것',type:'o'},{kw:'해당하는 것',type:'o'},
            {kw:'아닌',type:'x'},{kw:'틀린',type:'x'},{kw:'없는',type:'x'},{kw:'아닌 경우를 모두 고른 것',type:'x'}];
        const titleEl=document.getElementById('question-title'), textEl=document.getElementById('question-text');
        [titleEl,textEl].forEach(el=>{
            let html=el.innerHTML; reps.forEach(({kw,type})=>{
                const re=new RegExp(kw,'g'); html=html.replace(re, `<span class="clickable-word" data-type="${type}">${kw}</span>`);
            }); el.innerHTML=html;
        });
        document.querySelectorAll('.clickable-word').forEach(span=>{
            span.addEventListener('click',()=>{
                if(span.classList.contains('selected-o')||span.classList.contains('selected-x')){ span.classList.remove('selected-o','selected-x'); markMode=null; }
                else{ document.querySelectorAll('.clickable-word').forEach(s=>s.classList.remove('selected-o','selected-x')); markMode=span.dataset.type; span.classList.add(markMode==='o'?'selected-o':'selected-x'); }
            });
        });
    }

    async function toggleChoiceMark(li, choiceNo){
        const ex=li.querySelector('.mark-o,.mark-x');
        if(ex){ ex.remove(); li.classList.remove('disabled-choice'); }
        else{
            // 서버 소거 상태 반영(세션 범위 저장)
            try{ await axios.patch('/problems/practice/eliminate', null, { params:{ itemId: items[currentIndex].itemId, choiceNo } }); }catch(e){}
            li.classList.add('disabled-choice');
            const symbol=markMode==='o'?'X':'O', cls=markMode==='o'?'mark-x':'mark-o';
            li.querySelector('.choice-text').insertAdjacentHTML('beforeend', `<span class="${cls}">${symbol}</span>`);
        }
    }

    /* ===== nav buttons ===== */
    document.getElementById('next-btn').addEventListener('click',()=>{ if(currentIndex<items.length-1){ currentIndex++; showQuestion(currentIndex);} });
    document.getElementById('prev-btn').addEventListener('click',()=>{ if(currentIndex>0){ currentIndex--; showQuestion(currentIndex);} });
    document.getElementById('problem-btn').addEventListener('click',()=>{
        document.getElementById('solution-area').style.display='none';
        document.querySelectorAll('#choices .list-group-item').forEach(li=>li.classList.remove('choice-correct','choice-wrong'));
    });
    document.getElementById('solution-btn').addEventListener('click',()=>{
        const q=items[currentIndex]; highlightAnswer(q.answer,q.answer);
        document.getElementById('solution-text').textContent=`정답: ${q.answer ?? '-'}`;
        document.getElementById('solution-area').style.display='block';
    });

    /* ===== zoom ===== */
    let baseFontSize=16; function applyZoom(){ document.documentElement.style.fontSize=baseFontSize+'px'; }
    document.getElementById('zoom-in-btn').addEventListener('click',()=>{ baseFontSize=Math.min(baseFontSize+1,32); applyZoom(); });
    document.getElementById('zoom-out-btn').addEventListener('click',()=>{ baseFontSize=Math.max(baseFontSize-1,10); applyZoom(); });

    /* ===== settings ===== */
    const settingsBtn=document.getElementById('settings-btn'), settingsPanel=document.getElementById('settings-panel');
    settingsBtn?.addEventListener('click',()=>{ settingsPanel.style.display=settingsPanel.style.display==='block'?'none':'block'; });

    document.addEventListener('click',(e)=>{ if(!settingsPanel.contains(e.target)&&!settingsBtn.contains(e.target)) settingsPanel.style.display='none';});
</script>
</body>
</html>
