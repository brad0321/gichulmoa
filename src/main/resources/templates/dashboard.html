<!-- src/main/resources/templates/dashboard.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>ëŒ€ì‹œë³´ë“œ | ê³µì¸ì¤‘ê°œì‚¬ ê¸°ì¶œëª¨ì•„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        :root{
            --color-main:#2F4858;   /* Deep Teal Blue */
            --color-sub:#4F7CAC;    /* Smoky Blue */
            --color-point:#F5CD90;  /* Warm Pastel Yellow */
            --text-main:#2C3E3F;    /* Dark Charcoal */
            --text-sub:#7A746E;     /* Warm Gray */
            --bg:#F4F3F1;           /* Warm Light Gray */
            --white:#fff;

            --radius-lg:20px;
            --shadow-sm:0 6px 18px rgba(47,72,88,.10);

            --sidebar-w: 260px;
            --topbar-h: 60px;
        }

        html,body{height:100%}
        body{margin:0; background:var(--bg); color:var(--text-main); font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

        .app{
            display:grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: var(--topbar-h) 1fr;
            grid-template-areas: "sidebar topbar" "sidebar main";
            min-height:100vh;
        }

        /* Sidebar */
        .sidebar{ grid-area:sidebar; background:var(--color-main); color:#e7eef3; padding:24px 18px; }
        .sb-title{ font-weight:900; letter-spacing:.6px; font-size:22px; margin-bottom:18px; }
        .sb-nav{ display:flex; flex-direction:column; gap:6px; }
        .sb-link{ display:flex; align-items:center; gap:10px; color:#e7eef3; text-decoration:none; font-weight:700; padding:12px; border-radius:14px; }
        .sb-link:hover{ background:rgba(255,255,255,.08); }
        .sb-link.active{ background:rgba(255,255,255,.14); }
        .sb-link.locked-link{ position:relative; opacity:.8; }
        .sb-link.locked-link::after{ content:"ğŸ”’"; margin-left:6px; font-size:14px; }
        .sb-link.locked-link:hover{ background:rgba(255,255,255,.08); }

        /* Topbar */
        .topbar{ grid-area:topbar; display:flex; align-items:center; justify-content:space-between; padding:0 14px; background:var(--white); box-shadow:var(--shadow-sm); position:sticky; top:0; z-index:5; }
        .brand{ display:flex; align-items:center; gap:10px; }
        .brand img{ height:28px; }
        .brand .title{ font-weight:900; letter-spacing:.2px; }
        .top-right{ display:flex; align-items:center; gap:12px; }
        .hello{ color:var(--text-sub); }
        .pill{ border-radius:999px; padding:6px 10px; font-weight:700; font-size:.85rem; background:#e9eef3; color:var(--color-main); }
        .avatar-link{ display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; background:#e8edf1; text-decoration:none; overflow:hidden; }
        .avatar-img{ width:36px; height:36px; object-fit:cover; border-radius:50%; }

        /* Main */
        .main{ grid-area:main; padding:24px; }
        .wrap{ max-width:1200px; margin:0 auto; }

        /* ì¹´ë“œ ë ˆì´ì•„ì›ƒ */
        .top-grid{ display:grid; grid-template-columns: 1fr; grid-auto-rows: minmax(120px, auto); gap:14px; margin-bottom:16px; }
        .card-count{display:flex; align-items:center; justify-content:space-between; gap:16px; background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:20px 22px; min-height:120px;}
        .dhuge{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap; }
        .dhuge .label{ background:linear-gradient(135deg,var(--color-main),var(--color-sub)); color:#fff; font-weight:900; border-radius:999px; padding:6px 12px; font-size:1rem; }
        .dhuge .big{ font-weight:900; line-height:1; font-size:clamp(42px, 8vw, 96px); color:var(--color-main); }
        .count-detail{ color:var(--text-sub); font-weight:700; }
        .kpi-row{ display:grid; gap:14px; grid-template-columns: repeat(3,1fr); }
        @media (max-width:900px){ .kpi-row{ grid-template-columns: 1fr 1fr; } }
        @media (max-width:600px){ .kpi-row{ grid-template-columns: 1fr; } }
        .card-kpi{ background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:18px; min-height:88px; display:flex; flex-direction:column; justify-content:center; }
        .kpi-value{ font-size:28px; font-weight:900; margin-bottom:6px; }
        .kpi-label{ color:var(--text-sub); font-weight:700; }

        .bottom-grid{ display:grid; gap:14px; grid-template-columns: 1.2fr 1fr 1fr; grid-auto-rows: minmax(260px, auto); }
        @media (max-width:1100px){ .bottom-grid{ grid-template-columns: 1fr 1fr; } }
        @media (max-width:700px){ .bottom-grid{ grid-template-columns: 1fr; } }
        .cardx{ background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:18px; }
        .card-title{ font-weight:900; margin-bottom:8px; }

        /* ì ê¸ˆ ì˜¤ë²„ë ˆì´ */
        .lockable{ position:relative; }
        .locked-overlay{
            position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
            background:rgba(47,72,88,.22); backdrop-filter: blur(2.5px) saturate(0.7);
            border-radius:20px; z-index:10; cursor:pointer;
        }
        .locked-overlay .badge{
            background:linear-gradient(135deg,var(--color-main),var(--color-sub));
            color:#fff; font-weight:900; border-radius:999px; padding:10px 16px;
            box-shadow:var(--shadow-sm);
        }
        .locked-dim{ filter:grayscale(.6) opacity(.55); pointer-events:none; }
    </style>
</head>
<body>
<div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sb-title">DASHBOARD</div>
        <nav class="sb-nav">
            <a class="sb-link active" th:href="@{/dashboard}">í™ˆ</a>
            <a class="sb-link" th:href="@{/problems/solve}">ê¸°ì¶œë¬¸ì œ í’€ì´</a>

            <!-- ê²ŒìŠ¤íŠ¸ ì „ìš© (ì ê¸ˆ) -->
            <a class="sb-link locked-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" th:if="${isGuest}">íšŒì°¨ë³„ ì‹œí—˜</a>
            <a class="sb-link locked-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" th:if="${isGuest}">ì˜¤ë‹µë…¸íŠ¸</a>
            <a class="sb-link locked-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" th:if="${isGuest}">í†µê³„</a>

            <!-- íšŒì› ì „ìš© (ì‹¤ì œ ë§í¬) -->
            <a class="sb-link" th:href="@{/exams}"      th:if="${!isGuest}">íšŒì°¨ë³„ ì‹œí—˜</a>
            <a class="sb-link" th:href="@{/wrong-note}" th:if="${!isGuest}">ì˜¤ë‹µë…¸íŠ¸</a>
            <a class="sb-link" th:href="@{/stats}"      th:if="${!isGuest}">í†µê³„</a>

            <!-- ê´€ë¦¬ì ì „ìš©: ë¬¸ì œë“±ë¡ -->
            <a class="sb-link"
               th:href="@{/problems/new}"
               th:if="${!isGuest and loginUser.role.name() == 'ADMIN'}">ë¬¸ì œë“±ë¡</a>
        </nav>
    </aside>

    <!-- Topbar -->
    <header class="topbar">
        <div class="brand">
            <img src="/img/brandLogo.png" alt="ë¡œê³ ">
            <div class="title">ê³µì¸ì¤‘ê°œì‚¬ ê¸°ì¶œëª¨ì•„</div>
        </div>
        <div class="top-right">
            <span class="hello">ì•ˆë…•í•˜ì„¸ìš”, <strong th:text="${displayName}">ì‚¬ìš©ì</strong>ë‹˜</span>
            <span class="pill">ëŒ€ì‹œë³´ë“œ</span>
            <a class="avatar-link" th:href="${isGuest} ? '/login' : '/members/mypage'">
                <img class="avatar-img" src="/img/profile.png" alt="í”„ë¡œí•„">
            </a>
        </div>
    </header>

    <!-- Main -->
    <main class="main">
        <div class="wrap">
            <section class="top-grid" id="lock-kpi">
                <!-- ë‚¨ì€ ì‹œí—˜ê¸°ê°„: í•­ìƒ ì˜¤í”ˆ -->
                <article class="card-count" id="countdown-card">
                    <div class="dhuge">
                        <span class="label" id="dBadge">D-00</span>
                        <span class="big" id="dBig">D-00</span>
                    </div>
                    <div class="count-detail" id="countText">00ì¼ 00ì‹œê°„ 00ë¶„ 00ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤.</div>
                </article>

                <!-- KPI: ê²ŒìŠ¤íŠ¸ëŠ” ì ê¸ˆ -->
                <div class="kpi-row">
                    <div class="card-kpi"><div class="kpi-value" th:text="${todaySolved}">0</div><div class="kpi-label">ì˜¤ëŠ˜ í‘¼ ë¬¸ì œ</div></div>
                    <div class="card-kpi"><div class="kpi-value" th:text="${accuracy + '%'}">0%</div><div class="kpi-label">ì •ë‹µë¥ </div></div>
                    <div class="card-kpi"><div class="kpi-value" th:text="${streakDays + 'ì¼'}">0ì¼</div><div class="kpi-label">ì—°ì† ì¶œì„ì¼</div></div>
                </div>
            </section>

            <!-- í•˜ë‹¨ ì¹´ë“œë“¤: ê²ŒìŠ¤íŠ¸ëŠ” ì ê¸ˆ -->
            <section class="bottom-grid" id="lock-charts">
                <article class="cardx"><div class="card-title">ì¶œì„ í˜„í™©</div><div id="calDays"></div></article>
                <article class="cardx"><div class="card-title">ê³¼ëª©ë³„ ì •ë‹µë¥ </div><div class="chart-box"><svg id="barChart"></svg></div></article>
                <article class="cardx"><div class="card-title">ì£¼ê°„ í’€ì´ ì¶”ì´</div><div class="chart-box"><svg id="lineChart"></svg></div></article>
            </section>
        </div>
    </main>
</div>

<!-- ë¡œê·¸ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header" style="background: var(--color-main); color:#fff;">
                <h5 class="modal-title">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">íšŒì›ë§Œ ì´ìš©í•  ìˆ˜ ìˆëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ ë˜ëŠ” íšŒì›ê°€ì…ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.</div>
            <div class="modal-footer">
                <a th:href="@{/login}" class="btn btn-primary">ë¡œê·¸ì¸</a>
                <a th:href="@{/members/new}" class="btn btn-outline-secondary">íšŒì›ê°€ì…</a>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // ===== 0) ë¡œê·¸ì¸ ìƒíƒœ(ì„œë²„ íŒë³„ ê²°ê³¼ ì‚¬ìš©) =====
    const IS_GUEST = /*[[${isGuest}]]*/ false; // ì•ˆì „í•œ ê¸°ë³¸ê°’ false

    // ===== 1) D-Day ì¹´ìš´íŠ¸ë‹¤ìš´ (KST, 2025-10-25 09:30 ì‹œì‘) =====
    const EXAM_DATE_KST = new Date('2025-10-25T09:30:00+09:00');
    const msPerSec = 1000, msPerMin = 60*msPerSec, msPerHour = 60*msPerMin, msPerDay = 24*msPerHour;

    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    function updateCountdown(){
        const now = new Date();
        const diff = EXAM_DATE_KST.getTime() - now.getTime();

        // D-í‘œì‹œëŠ” ë‚ ì§œ ê¸°ì¤€(ë‹¹ì¼ 0ì‹œëŠ” D-0), ë³¸ë¬¸ ì¹´ìš´íŠ¸ë‹¤ìš´ì€ 09:30ê¹Œì§€ ì´ˆë‹¨ìœ„
        const dToday  = startOfDay(now);
        const dTarget = startOfDay(EXAM_DATE_KST);
        const dGap    = Math.ceil((dTarget - dToday) / msPerDay); // ìŒìˆ˜ë©´ D+N
        const dText   = dGap > 0 ? `D-${dGap}` : (dGap === 0 ? 'D-0' : `D+${Math.abs(dGap)}`);

        const $badge = document.getElementById('dBadge');
        const $big   = document.getElementById('dBig');
        const $text  = document.getElementById('countText');

        if ($badge) $badge.textContent = dText;
        if ($big)   $big.textContent   = dText;

        if (diff <= 0){
            if ($text) $text.textContent = dGap === 0 ? 'ì˜¤ëŠ˜ 09:30 ì‹œí—˜ì´ ì‹œì‘ë©ë‹ˆë‹¤.' : 'ì‹œí—˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            return;
        }

        const days  = Math.floor(diff / msPerDay);
        const hours = Math.floor((diff % msPerDay) / msPerHour);
        const mins  = Math.floor((diff % msPerHour) / msPerMin);
        const secs  = Math.floor((diff % msPerMin) / msPerSec);

        if ($text) $text.textContent = `${days}ì¼ ${String(hours).padStart(2,'0')}ì‹œê°„ ${String(mins).padStart(2,'0')}ë¶„ ${String(secs).padStart(2,'0')}ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`;
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // ===== 2) ê²ŒìŠ¤íŠ¸ ì ê¸ˆ (ì¹´ìš´íŠ¸ë‹¤ìš´ ì œì™¸) =====
    function makeLockOverlay(cardEl){
        if (!cardEl) return;
        cardEl.classList.add('locked-dim');
        cardEl.style.position = cardEl.style.position || 'relative';
        const ov = document.createElement('div');
        ov.className = 'locked-overlay';
        ov.innerHTML = `<span class="badge">íšŒì› ì „ìš© Â· ë¡œê·¸ì¸ í•„ìš” ğŸ”’</span>`;
        ov.onclick = ()=> new bootstrap.Modal(document.getElementById('loginModal')).show();
        cardEl.appendChild(ov);
    }

    function lockForGuest(){
        if (!IS_GUEST) return;

        // 2-1) KPI ì¹´ë“œ ì ê¸ˆ (ì¹´ìš´íŠ¸ë‹¤ìš´ ì¹´ë“œ ì œì™¸)
        document.querySelectorAll('#lock-kpi .card-kpi').forEach(makeLockOverlay);

        // 2-2) í•˜ë‹¨ ì¹´ë“œ ì „ì²´ ì ê¸ˆ
        document.querySelectorAll('#lock-charts .cardx').forEach(makeLockOverlay);
    }
    lockForGuest();
</script>
</body>
</html>
