<!-- src/main/resources/templates/dashboard.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>대시보드 | 공인중개사 기출모아</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        :root{
            --color-main:#2F4858;   /* Deep Teal Blue */
            --color-sub:#4F7CAC;    /* Smoky Blue */
            --color-point:#F5CD90;  /* Warm Pastel Yellow */
            --text-main:#2C3E3F;    /* Dark Charcoal */
            --text-sub:#7A746E;     /* Warm Gray */
            --bg:#F4F3F1;           /* Warm Light Gray */
            --white:#fff;

            --radius-lg:20px;
            --shadow-sm:0 6px 18px rgba(47,72,88,.10);

            --sidebar-w: 260px;
            --topbar-h: 60px;
        }

        html,body{height:100%}
        body{margin:0; background:var(--bg); color:var(--text-main); font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

        .app{
            display:grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: var(--topbar-h) 1fr;
            grid-template-areas: "sidebar topbar" "sidebar main";
            min-height:100vh;
        }

        /* Sidebar */
        .sidebar{ grid-area:sidebar; background:var(--color-main); color:#e7eef3; padding:24px 18px; }
        .sb-title{ font-weight:900; letter-spacing:.6px; font-size:22px; margin-bottom:18px; }
        .sb-nav{ display:flex; flex-direction:column; gap:6px; }
        .sb-link{ display:flex; align-items:center; gap:10px; color:#e7eef3; text-decoration:none; font-weight:700; padding:12px; border-radius:14px; }
        .sb-link:hover{ background:rgba(255,255,255,.08); }
        .sb-link.active{ background:rgba(255,255,255,.14); }
        .sb-link.locked-link{ position:relative; opacity:.8; }
        .sb-link.locked-link::after{ content:"🔒"; margin-left:6px; font-size:14px; }
        .sb-link.locked-link:hover{ background:rgba(255,255,255,.08); }

        /* Topbar */
        .topbar{ grid-area:topbar; display:flex; align-items:center; justify-content:space-between; padding:0 14px; background:var(--white); box-shadow:var(--shadow-sm); position:sticky; top:0; z-index:5; }
        .brand{ display:flex; align-items:center; gap:10px; }
        .brand img{ height:28px; }
        .brand .title{ font-weight:900; letter-spacing:.2px; }
        .top-right{ display:flex; align-items:center; gap:12px; }
        .hello{ color:var(--text-sub); }
        .pill{ border-radius:999px; padding:6px 10px; font-weight:700; font-size:.85rem; background:#e9eef3; color:var(--color-main); }
        .avatar-link{ display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; background:#e8edf1; text-decoration:none; overflow:hidden; }
        .avatar-img{ width:36px; height:36px; object-fit:cover; border-radius:50%; }

        /* Main */
        .main{ grid-area:main; padding:24px; }
        .wrap{ max-width:1200px; margin:0 auto; }

        /* 카드 레이아웃 */
        .top-grid{ display:grid; grid-template-columns: 1fr; grid-auto-rows: minmax(120px, auto); gap:14px; margin-bottom:16px; }
        .card-count{display:flex; align-items:center; justify-content:space-between; gap:16px; background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:20px 22px; min-height:120px;}
        .dhuge{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap; }
        .dhuge .label{ background:linear-gradient(135deg,var(--color-main),var(--color-sub)); color:#fff; font-weight:900; border-radius:999px; padding:6px 12px; font-size:1rem; }
        .dhuge .big{ font-weight:900; line-height:1; font-size:clamp(42px, 8vw, 96px); color:var(--color-main); }
        .count-detail{ color:var(--text-sub); font-weight:700; }
        .kpi-row{ display:grid; gap:14px; grid-template-columns: repeat(3,1fr); }
        @media (max-width:900px){ .kpi-row{ grid-template-columns: 1fr 1fr; } }
        @media (max-width:600px){ .kpi-row{ grid-template-columns: 1fr; } }
        .card-kpi{ background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:18px; min-height:88px; display:flex; flex-direction:column; justify-content:center; }
        .kpi-value{ font-size:28px; font-weight:900; margin-bottom:6px; }
        .kpi-label{ color:var(--text-sub); font-weight:700; }

        .bottom-grid{ display:grid; gap:14px; grid-template-columns: 1.2fr 1fr 1fr; grid-auto-rows: minmax(260px, auto); }
        @media (max-width:1100px){ .bottom-grid{ grid-template-columns: 1fr 1fr; } }
        @media (max-width:700px){ .bottom-grid{ grid-template-columns: 1fr; } }
        .cardx{ background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:18px; }
        .card-title{ font-weight:900; margin-bottom:8px; }

        /* 잠금 오버레이 */
        .lockable{ position:relative; }
        .locked-overlay{
            position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
            background:rgba(47,72,88,.22); backdrop-filter: blur(2.5px) saturate(0.7);
            border-radius:20px; z-index:10; cursor:pointer;
        }
        .locked-overlay .badge{
            background:linear-gradient(135deg,var(--color-main),var(--color-sub));
            color:#fff; font-weight:900; border-radius:999px; padding:10px 16px;
            box-shadow:var(--shadow-sm);
        }
        .locked-dim{ filter:grayscale(.6) opacity(.55); pointer-events:none; }
    </style>
</head>
<body>
<div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sb-title">DASHBOARD</div>
        <nav class="sb-nav">
            <a class="sb-link active" th:href="@{/dashboard}">홈</a>
            <a class="sb-link" th:href="@{/problems/solve}">기출문제 풀이</a>

            <!-- 게스트 전용 (잠금) -->
            <a class="sb-link locked-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" th:if="${isGuest}">회차별 시험</a>
            <a class="sb-link locked-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" th:if="${isGuest}">오답노트</a>
            <a class="sb-link locked-link" href="#" data-bs-toggle="modal" data-bs-target="#loginModal" th:if="${isGuest}">통계</a>

            <!-- 회원 전용 (실제 링크) -->
            <a class="sb-link" th:href="@{/exams}"      th:if="${!isGuest}">회차별 시험</a>
            <a class="sb-link" th:href="@{/wrong-note}" th:if="${!isGuest}">오답노트</a>
            <a class="sb-link" th:href="@{/stats}"      th:if="${!isGuest}">통계</a>

            <!-- 관리자 전용: 문제등록 -->
            <a class="sb-link"
               th:href="@{/problems/new}"
               th:if="${!isGuest and loginUser.role.name() == 'ADMIN'}">문제등록</a>
        </nav>
    </aside>

    <!-- Topbar -->
    <header class="topbar">
        <div class="brand">
            <img src="/img/brandLogo.png" alt="로고">
            <div class="title">공인중개사 기출모아</div>
        </div>
        <div class="top-right">
            <span class="hello">안녕하세요, <strong th:text="${displayName}">사용자</strong>님</span>
            <span class="pill">대시보드</span>
            <a class="avatar-link" th:href="${isGuest} ? '/login' : '/members/mypage'">
                <img class="avatar-img" src="/img/profile.png" alt="프로필">
            </a>
        </div>
    </header>

    <!-- Main -->
    <main class="main">
        <div class="wrap">
            <section class="top-grid" id="lock-kpi">
                <!-- 남은 시험기간: 항상 오픈 -->
                <article class="card-count" id="countdown-card">
                    <div class="dhuge">
                        <span class="label" id="dBadge">D-00</span>
                        <span class="big" id="dBig">D-00</span>
                    </div>
                    <div class="count-detail" id="countText">00일 00시간 00분 00초 남았습니다.</div>
                </article>

                <!-- KPI: 게스트는 잠금 -->
                <div class="kpi-row">
                    <div class="card-kpi"><div class="kpi-value" th:text="${todaySolved}">0</div><div class="kpi-label">오늘 푼 문제</div></div>
                    <div class="card-kpi"><div class="kpi-value" th:text="${accuracy + '%'}">0%</div><div class="kpi-label">정답률</div></div>
                    <div class="card-kpi"><div class="kpi-value" th:text="${streakDays + '일'}">0일</div><div class="kpi-label">연속 출석일</div></div>
                </div>
            </section>

            <!-- 하단 카드들: 게스트는 잠금 -->
            <section class="bottom-grid" id="lock-charts">
                <article class="cardx"><div class="card-title">출석 현황</div><div id="calDays"></div></article>
                <article class="cardx"><div class="card-title">과목별 정답률</div><div class="chart-box"><svg id="barChart"></svg></div></article>
                <article class="cardx"><div class="card-title">주간 풀이 추이</div><div class="chart-box"><svg id="lineChart"></svg></div></article>
            </section>
        </div>
    </main>
</div>

<!-- 로그인 모달 -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px;">
            <div class="modal-header" style="background: var(--color-main); color:#fff;">
                <h5 class="modal-title">로그인이 필요합니다</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">회원만 이용할 수 있는 기능입니다. 로그인 또는 회원가입을 진행해주세요.</div>
            <div class="modal-footer">
                <a th:href="@{/login}" class="btn btn-primary">로그인</a>
                <a th:href="@{/members/new}" class="btn btn-outline-secondary">회원가입</a>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    // ===== 0) 로그인 상태(서버 판별 결과 사용) =====
    const IS_GUEST = /*[[${isGuest}]]*/ false; // 안전한 기본값 false

    // ===== 1) D-Day 카운트다운 (KST, 2025-10-25 09:30 시작) =====
    const EXAM_DATE_KST = new Date('2025-10-25T09:30:00+09:00');
    const msPerSec = 1000, msPerMin = 60*msPerSec, msPerHour = 60*msPerMin, msPerDay = 24*msPerHour;

    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

    function updateCountdown(){
        const now = new Date();
        const diff = EXAM_DATE_KST.getTime() - now.getTime();

        // D-표시는 날짜 기준(당일 0시는 D-0), 본문 카운트다운은 09:30까지 초단위
        const dToday  = startOfDay(now);
        const dTarget = startOfDay(EXAM_DATE_KST);
        const dGap    = Math.ceil((dTarget - dToday) / msPerDay); // 음수면 D+N
        const dText   = dGap > 0 ? `D-${dGap}` : (dGap === 0 ? 'D-0' : `D+${Math.abs(dGap)}`);

        const $badge = document.getElementById('dBadge');
        const $big   = document.getElementById('dBig');
        const $text  = document.getElementById('countText');

        if ($badge) $badge.textContent = dText;
        if ($big)   $big.textContent   = dText;

        if (diff <= 0){
            if ($text) $text.textContent = dGap === 0 ? '오늘 09:30 시험이 시작됩니다.' : '시험이 종료되었습니다.';
            return;
        }

        const days  = Math.floor(diff / msPerDay);
        const hours = Math.floor((diff % msPerDay) / msPerHour);
        const mins  = Math.floor((diff % msPerHour) / msPerMin);
        const secs  = Math.floor((diff % msPerMin) / msPerSec);

        if ($text) $text.textContent = `${days}일 ${String(hours).padStart(2,'0')}시간 ${String(mins).padStart(2,'0')}분 ${String(secs).padStart(2,'0')}초 남았습니다.`;
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);

    // ===== 2) 게스트 잠금 (카운트다운 제외) =====
    function makeLockOverlay(cardEl){
        if (!cardEl) return;
        cardEl.classList.add('locked-dim');
        cardEl.style.position = cardEl.style.position || 'relative';
        const ov = document.createElement('div');
        ov.className = 'locked-overlay';
        ov.innerHTML = `<span class="badge">회원 전용 · 로그인 필요 🔒</span>`;
        ov.onclick = ()=> new bootstrap.Modal(document.getElementById('loginModal')).show();
        cardEl.appendChild(ov);
    }

    function lockForGuest(){
        if (!IS_GUEST) return;

        // 2-1) KPI 카드 잠금 (카운트다운 카드 제외)
        document.querySelectorAll('#lock-kpi .card-kpi').forEach(makeLockOverlay);

        // 2-2) 하단 카드 전체 잠금
        document.querySelectorAll('#lock-charts .cardx').forEach(makeLockOverlay);
    }
    lockForGuest();
</script>
</body>
</html>
