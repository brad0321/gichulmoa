<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>대시보드 | 공인중개사 기출모아</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
        :root{
            --color-main:#2F4858;   /* Deep Teal Blue */
            --color-sub:#4F7CAC;    /* Smoky Blue */
            --color-point:#F5CD90;  /* Warm Pastel Yellow */
            --text-main:#2C3E3F;    /* Dark Charcoal */
            --text-sub:#7A746E;     /* Warm Gray */
            --bg:#F4F3F1;           /* Warm Light Gray */
            --white:#fff;

            --radius-lg:20px;
            --shadow-sm:0 6px 18px rgba(47,72,88,.10);

            --sidebar-w: 260px;
            --topbar-h: 60px;
        }

        html,body{height:100%}
        body{margin:0; background:var(--bg); color:var(--text-main); font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

        /* Layout */
        .app{
            display:grid;
            grid-template-columns: var(--sidebar-w) 1fr;
            grid-template-rows: var(--topbar-h) 1fr;
            grid-template-areas: "sidebar topbar" "sidebar main";
            min-height:100vh;
        }

        /* Sidebar */
        .sidebar{ grid-area:sidebar; background:var(--color-main); color:#e7eef3; padding:24px 18px; }
        .sb-title{ font-weight:900; letter-spacing:.6px; font-size:22px; margin-bottom:18px; }
        .sb-nav{ display:flex; flex-direction:column; gap:6px; }
        .sb-link{ display:flex; align-items:center; gap:10px; color:#e7eef3; text-decoration:none; font-weight:700; padding:12px; border-radius:14px; }
        .sb-link:hover{ background:rgba(255,255,255,.08); }
        .sb-link.active{ background:rgba(255,255,255,.14); }

        /* Topbar */
        .topbar{ grid-area:topbar; display:flex; align-items:center; justify-content:space-between; padding:0 14px; background:var(--white); box-shadow:var(--shadow-sm); position:sticky; top:0; z-index:5; }
        .brand{ display:flex; align-items:center; gap:10px; }
        .brand img{ height:28px; }
        .brand .title{ font-weight:900; letter-spacing:.2px; }
        .top-right{ display:flex; align-items:center; gap:12px; }
        .hello{ color:var(--text-sub); }
        .pill{ border-radius:999px; padding:6px 10px; font-weight:700; font-size:.85rem; background:#e9eef3; color:var(--color-main); }
        .avatar-link{ display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; background:#e8edf1; text-decoration:none; overflow:hidden; }
        .avatar-img{ width:36px; height:36px; object-fit:cover; border-radius:50%; }

        /* Main */
        .main{ grid-area:main; padding:24px; }
        .wrap{ max-width:1200px; margin:0 auto; }

        /* ===== 상단: 카운트다운 + KPI ===== */
        .top-grid{ display:grid; grid-template-columns: 1fr; grid-auto-rows: minmax(120px, auto); gap:14px; margin-bottom:16px; }

        .card-count{
            display:flex; align-items:center; justify-content:space-between; gap:16px;
            background:#fff; border-radius:20px; box-shadow:var(--shadow-sm);
            padding:20px 22px; min-height:120px; overflow:hidden;
        }
        .dhuge{ display:flex; align-items:baseline; gap:12px; flex-wrap:wrap; }
        .dhuge .label{ background:linear-gradient(135deg,var(--color-main),var(--color-sub)); color:#fff; font-weight:900; border-radius:999px; padding:6px 12px; font-size:1rem; }
        .dhuge .big{ font-weight:900; line-height:1; font-size:clamp(42px, 8vw, 96px); letter-spacing:-1px; color:var(--color-main); }
        .count-detail{ color:var(--text-sub); font-weight:700; }

        .kpi-row{ display:grid; gap:14px; grid-template-columns: repeat(3,1fr); }
        @media (max-width:900px){ .kpi-row{ grid-template-columns: 1fr 1fr; } }
        @media (max-width:600px){ .kpi-row{ grid-template-columns: 1fr; } }
        .card-kpi{ background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:18px; min-height:88px; display:flex; flex-direction:column; justify-content:center; overflow:hidden; }
        .kpi-value{ font-size:28px; font-weight:900; line-height:1; margin-bottom:6px; }
        .kpi-label{ color:var(--text-sub); font-weight:700; }

        /* ===== 하단: 달력 + 차트 ===== */
        .bottom-grid{ display:grid; gap:14px; grid-template-columns: 1.2fr 1fr 1fr; grid-auto-rows: minmax(260px, auto); }
        @media (max-width:1100px){ .bottom-grid{ grid-template-columns: 1fr 1fr; } }
        @media (max-width:700px){ .bottom-grid{ grid-template-columns: 1fr; } }

        .cardx{ background:#fff; border-radius:20px; box-shadow:var(--shadow-sm); padding:18px; overflow:hidden; }
        .card-title{ font-weight:900; margin-bottom:8px; }

        .cal-head{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
        .cal-title{ font-weight:900; }
        .dday-badge{ padding:4px 10px; border-radius:999px; font-weight:900; font-size:.9rem; color:#fff; background:linear-gradient(135deg,var(--color-main),var(--color-sub)); }
        .cal-grid{ display:grid; grid-template-columns: repeat(7,1fr); gap:6px; }
        .cal-wd{ text-align:center; color:var(--text-sub); font-weight:800; padding:4px 0; }
        .cal-cell{ background:#fff; text-align:center; padding:12px 0; border-radius:14px; box-shadow:var(--shadow-sm); min-height:54px; font-weight:800; color:var(--text-main); }
        .cal-cell.muted{ opacity:.5; }
        .cal-cell.today{ outline:2px solid var(--color-sub); }
        .cal-cell .dot{ margin-top:4px; width:10px; height:10px; border-radius:50%; display:inline-block; background:var(--color-point); }
        .cal-cell.highlight{ background:#fff7ea; border:1px solid #f0d9a8; }

        .chart-box{ background:#fff; border-radius:14px; padding:10px; box-shadow:var(--shadow-sm); height:220px; display:flex; align-items:center; }
        .chart-box svg{ width:100%; height:100%; display:block; }
        .tick .num{ background:var(--color-point); color:#5b4526; border-radius:10px; padding:2px 8px; margin:0 2px; font-feature-settings:"tnum"; }
    </style>
</head>
<body>
<div class="app">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sb-title">DASHBOARD</div>
        <nav class="sb-nav">
            <a class="sb-link active" th:href="@{/dashboard}">연습모드</a>
            <a class="sb-link" th:href="@{/exam-mode}">실전모드</a>
            <a class="sb-link" th:href="@{/wrong-notes}">오답노트</a>
            <a class="sb-link" th:href="@{/stats}">통계</a>
        </nav>
    </aside>

    <!-- Topbar -->
    <header class="topbar">
        <div class="brand">
            <img src="/img/brandLogo.png" alt="로고">
            <div class="title">공인중개사 기출모아</div>
        </div>
        <div class="top-right">
            <span class="hello">안녕하세요, <strong th:text="${loginUser.username}">사용자</strong>님</span>
            <span class="pill">대시보드</span>
            <a class="avatar-link" th:href="@{/members/mypage}" aria-label="마이페이지">
                <img class="avatar-img" src="/img/profile.png" alt="기본 프로필">
            </a>
        </div>
    </header>

    <!-- Main -->
    <main class="main">
        <div class="wrap">

            <!-- 상단: 카운트다운 + KPI -->
            <section class="top-grid">
                <article class="card-count">
                    <div class="dhuge">
                        <span class="label" id="dBadge">D-00</span>
                        <span class="big" id="dBig">D-00</span>
                    </div>
                    <div class="count-detail" id="countText">
                        <span class="num">00</span>일 <span class="num">00</span>시간
                        <span class="num">00</span>분 <span class="num">00</span>초 남았습니다.
                    </div>
                </article>

                <div class="kpi-row">
                    <div class="card-kpi">
                        <div class="kpi-value" th:text="${todaySolved}">12</div>
                        <div class="kpi-label">오늘 푼 문제</div>
                    </div>
                    <div class="card-kpi">
                        <div class="kpi-value" th:text="${accuracy + '%'}">80%</div>
                        <div class="kpi-label">정답률</div>
                    </div>
                    <div class="card-kpi">
                        <div class="kpi-value" th:text="${streakDays + '일'}">5일</div>
                        <div class="kpi-label">연속 출석일</div>
                    </div>
                </div>
            </section>

            <!-- 하단: 달력 + 차트 -->
            <section class="bottom-grid">
                <article class="cardx">
                    <div class="cal-head">
                        <div class="cal-title">출석 현황</div>
                        <div class="dday-badge" id="ddayBadge">D-00</div>
                    </div>
                    <div class="cal-grid mb-1">
                        <div class="cal-wd">일</div><div class="cal-wd">월</div><div class="cal-wd">화</div>
                        <div class="cal-wd">수</div><div class="cal-wd">목</div><div class="cal-wd">금</div><div class="cal-wd">토</div>
                    </div>
                    <!-- 서버가 JSON 문자열 제공 (없으면 '[]') -->
                    <div class="cal-grid" id="calDays"
                         th:data-attend="${attendDatesJson?:'[]'}"></div>
                </article>

                <article class="cardx">
                    <div class="card-title">과목별 정답률</div>
                    <div class="chart-box">
                        <svg id="barChart" viewBox="0 0 300 180"
                             th:data-labels="${subjectLabelsJson?:'[]'}"
                             th:data-values="${subjectAccJson?:'[]'}"></svg>
                    </div>
                </article>

                <article class="cardx">
                    <div class="card-title">주간 풀이 추이</div>
                    <div class="chart-box">
                        <svg id="lineChart" viewBox="0 0 300 180"
                             th:data-labels="${weeklyLabelsJson?:'[]'}"
                             th:data-values="${weeklySolvedJson?:'[]'}"></svg>
                    </div>
                </article>
            </section>

        </div>
    </main>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    /* ====== 유틸: data-* JSON 안전 파서 ====== */
    function getDataAttrJson(el, name, fallback) {
        const raw = el?.dataset?.[name];
        if (!raw || raw.trim() === '') return fallback;
        try { return JSON.parse(raw); } catch { return fallback; }
    }

    /* ====== 시험 D-day / 남은 기간 ====== */
    const examDateKST = new Date("2025-10-25T09:30:00+09:00");
    function updateDdayWidgets(){
        const now = new Date();
        const diff = examDateKST - now;
        const days = Math.max(0, Math.floor(diff/86400000));
        const hours = Math.floor((diff % 86400000)/3600000);
        const minutes = Math.floor((diff % 3600000)/60000);
        const seconds = Math.floor((diff % 60000)/1000);

        const dBadge = document.getElementById('ddayBadge');
        const dBadge2 = document.getElementById('dBadge');
        const dBig = document.getElementById('dBig');
        const countText = document.getElementById('countText');

        const label = (days===0) ? 'D-DAY' : `D-${days}`;
        if(dBadge) dBadge.textContent = label;
        if(dBadge2) dBadge2.textContent = label;
        if(dBig) dBig.textContent = label;

        if(countText){
            countText.innerHTML =
                `<span class="num">${String(days).padStart(2,'0')}</span>일
         <span class="num">${String(hours).padStart(2,'0')}</span>시간
         <span class="num">${String(minutes).padStart(2,'0')}</span>분
         <span class="num">${String(seconds).padStart(2,'0')}</span>초 남았습니다.`;
        }
    }
    setInterval(updateDdayWidgets, 1000); updateDdayWidgets();

    /* ====== 출석 달력 ====== */
    (function(){
        const calDays = document.getElementById('calDays');
        if(!calDays) return;

        const today = new Date(); today.setHours(0,0,0,0);
        const attend = getDataAttrJson(calDays, 'attend', []); // ["2025-08-03","2025-08-08",...]
        const attSet = new Set(attend);

        function fdate(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` }

        function renderCalendar(base = new Date()){
            calDays.innerHTML = '';
            const y = base.getFullYear(), m = base.getMonth();
            const first = new Date(y, m, 1), last = new Date(y, m+1, 0);
            const start = first.getDay(), total = last.getDate();
            const prevLast = new Date(y, m, 0).getDate();

            for(let i=prevLast-start+1; i<=prevLast; i++){
                const cell = document.createElement('div'); cell.className='cal-cell muted'; cell.textContent=i; calDays.appendChild(cell);
            }
            for(let d=1; d<=total; d++){
                const date = new Date(y, m, d), key = fdate(date);
                const cell = document.createElement('div'); cell.className='cal-cell';
                if(date.getTime()===today.getTime()) cell.classList.add('today');
                if(attSet.has(key)) cell.classList.add('highlight');
                cell.innerHTML = `${d}${attSet.has(key)?'<div class="dot"></div>':''}`;
                calDays.appendChild(cell);
            }
            while(calDays.children.length < 42){
                const cell = document.createElement('div'); cell.className='cal-cell muted'; cell.innerHTML='&nbsp;'; calDays.appendChild(cell);
            }
        }
        renderCalendar();
    })();

    /* ====== 경량 SVG 차트 ====== */

    // Bar (과목별 정답률)
    (function(){
        const svg = document.getElementById('barChart');
        if(!svg) return;

        const labels = getDataAttrJson(svg, 'labels', []); // e.g. ["개론","민법",...]
        const values = getDataAttrJson(svg, 'values', []); // e.g. [72,85,66,90]

        const W=300,H=180, pad=30, baseY=150, baseX=40, barW=28, gap=22;
        svg.innerHTML = `<line x1="${baseX}" y1="${baseY}" x2="${W-10}" y2="${baseY}" stroke="#ddd"/>
                     <line x1="${baseX}" y1="${baseY}" x2="${baseX}" y2="${pad}" stroke="#ddd"/>`;

        if (!values.length) {
            svg.insertAdjacentHTML('beforeend',
                `<text x="${W/2}" y="${H/2}" text-anchor="middle" font-size="12" fill="#7A746E">데이터 없음</text>`);
            return;
        }

        values.forEach((v,i)=>{
            const x = baseX + 10 + i*(barW+gap);
            const h = Math.max(0, Math.min(100, v)) * 1.1;
            const y = baseY - h;
            svg.insertAdjacentHTML('beforeend',
                `<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="6" fill="#F5CD90"></rect>
         <text x="${x+barW/2}" y="${baseY+14}" text-anchor="middle" font-size="10" fill="#7A746E">${labels[i]||''}</text>`);
        });

        [0,20,40,60,80,100].forEach(t=>{
            const yy = baseY - t*1.1;
            svg.insertAdjacentHTML('beforeend', `<text x="8" y="${yy+4}" font-size="10" fill="#7A746E">${t}%</text>`);
        });
    })();

    // Line (주간 풀이 추이)
    (function(){
        const svg = document.getElementById('lineChart');
        if(!svg) return;

        const labels = getDataAttrJson(svg, 'labels', []); // ["7/1","7/8",...]
        const values = getDataAttrJson(svg, 'values', []); // [6,9,13,17,20]

        const W=300,H=180, pad=30, baseY=150, baseX=30, max=Math.max(...values,1);
        const step=(W-baseX-10)/((values.length-1)||1);

        for(let g=1; g<=4; g++){
            const y = baseY - (g*(baseY-pad)/4);
            svg.insertAdjacentHTML('beforeend', `<line x1="${baseX}" y1="${y}" x2="${W-10}" y2="${y}" stroke="#eee"/>`);
        }
        svg.insertAdjacentHTML('beforeend', `<line x1="${baseX}" y1="${baseY}" x2="${W-10}" y2="${baseY}" stroke="#ddd"/>`);

        if (!values.length) {
            svg.insertAdjacentHTML('beforeend',
                `<text x="${W/2}" y="${H/2}" text-anchor="middle" font-size="12" fill="#7A746E">데이터 없음</text>`);
            return;
        }

        labels.forEach((lb,i)=>{
            const x = baseX + i*step;
            svg.insertAdjacentHTML('beforeend', `<text x="${x}" y="${baseY+14}" font-size="10" text-anchor="middle" fill="#7A746E">${lb||''}</text>`);
        });

        let d='';
        values.forEach((v,i)=>{
            const x = baseX + i*step;
            const y = baseY - (v/max)*(baseY-pad);
            d += (i===0?`M ${x} ${y}`:` L ${x} ${y}`);
            svg.insertAdjacentHTML('beforeend', `<circle cx="${x}" cy="${y}" r="3.5" fill="#C89C3A"></circle>`);
        });
        svg.insertAdjacentHTML('beforeend', `<path d="${d}" fill="none" stroke="#C89C3A" stroke-width="2.5"/>`);
    })();
</script>
</body>
</html>
